{
  "stage": 8,
  "stageName": "Cycle Expansion",
  "success": true,
  "expansions": [
    {
      "id": "CEXP-80B5B4B0",
      "originalEncounterId": "ENC-005",
      "originalName": "Cycle 2-6 Day 1",
      "originalRecurrence": {
        "pattern": "CYCLE:2-6",
        "type": "cycle_based",
        "startCycle": 2,
        "endCycle": 6,
        "provenance": {
          "pageNumber": 41,
          "tableId": "SOA-1",
          "colIdx": 5
        }
      },
      "expandedEncounterCount": 5,
      "expandedEncounterIds": [
        "ENC-005-C2",
        "ENC-005-C3",
        "ENC-005-C4",
        "ENC-005-C5",
        "ENC-005-C6"
      ],
      "expandedCycleNumbers": [
        2,
        3,
        4,
        5,
        6
      ],
      "saiDuplicationCount": 70,
      "expandedSaiIds": [
        "SAI-005-C2",
        "SAI-013-C2",
        "SAI-022-C2",
        "SAI-029-C2",
        "SAI-033-C2",
        "SAI-041-C2",
        "SAI-047-C2",
        "SAI-054-C2",
        "SAI-063-C2",
        "SAI-065-C2",
        "SAI-068-C2",
        "SAI-073-C2",
        "SAI-076-C2",
        "SAI-081-C2",
        "SAI-005-C3",
        "SAI-013-C3",
        "SAI-022-C3",
        "SAI-029-C3",
        "SAI-033-C3",
        "SAI-041-C3",
        "SAI-047-C3",
        "SAI-054-C3",
        "SAI-063-C3",
        "SAI-065-C3",
        "SAI-068-C3",
        "SAI-073-C3",
        "SAI-076-C3",
        "SAI-081-C3",
        "SAI-005-C4",
        "SAI-013-C4",
        "SAI-022-C4",
        "SAI-029-C4",
        "SAI-033-C4",
        "SAI-041-C4",
        "SAI-047-C4",
        "SAI-054-C4",
        "SAI-063-C4",
        "SAI-065-C4",
        "SAI-068-C4",
        "SAI-073-C4",
        "SAI-076-C4",
        "SAI-081-C4",
        "SAI-005-C5",
        "SAI-013-C5",
        "SAI-022-C5",
        "SAI-029-C5",
        "SAI-033-C5",
        "SAI-041-C5",
        "SAI-047-C5",
        "SAI-054-C5",
        "SAI-063-C5",
        "SAI-065-C5",
        "SAI-068-C5",
        "SAI-073-C5",
        "SAI-076-C5",
        "SAI-081-C5",
        "SAI-005-C6",
        "SAI-013-C6",
        "SAI-022-C6",
        "SAI-029-C6",
        "SAI-033-C6",
        "SAI-041-C6",
        "SAI-047-C6",
        "SAI-054-C6",
        "SAI-063-C6",
        "SAI-065-C6",
        "SAI-068-C6",
        "SAI-073-C6",
        "SAI-076-C6",
        "SAI-081-C6"
      ],
      "confidence": 1.0,
      "source": "cache",
      "rationale": "The recurrence pattern 'CYCLE:2-6' is an explicit range, indicating expansion from Cycle 2 through Cycle 6.",
      "requiresReview": false,
      "reviewReason": null,
      "provenance": {
        "pageNumber": 41,
        "tableId": "SOA-1",
        "colIdx": 5
      }
    }
  ],
  "decisions": {
    "ENC-005": {
      "encounterName": "Cycle 2-6 Day 1",
      "recurrenceKey": "NONE",
      "shouldExpand": true,
      "expandedCycles": [
        2,
        3,
        4,
        5,
        6
      ],
      "patternType": "explicit_range",
      "cycleLengthDays": 21,
      "confidence": 1.0,
      "rationale": "The recurrence pattern 'CYCLE:2-6' is an explicit range, indicating expansion from Cycle 2 through Cycle 6.",
      "source": "cache",
      "requiresHumanReview": false,
      "reviewReason": null,
      "cachedAt": "2025-12-09T21:41:22.619197Z",
      "modelName": "gemini-2.5-pro",
      "provenance": null,
      "isOpenEnded": false,
      "protocolContext": null
    },
    "ENC-008": {
      "encounterName": "Maintenance Therapy",
      "recurrenceKey": "FIXED_INTERVAL:1_weeks",
      "shouldExpand": false,
      "expandedCycles": [],
      "patternType": null,
      "cycleLengthDays": 21,
      "confidence": 0.0,
      "rationale": "The fixed interval 'P3W' (every 3 weeks) is an open-ended pattern. The protocol does not specify the maximum number of maintenance cycles, requiring human review.",
      "source": "cache",
      "requiresHumanReview": true,
      "reviewReason": "Open-ended pattern - protocol does not specify max cycle count for 'P3W'.",
      "cachedAt": "2025-12-09T21:41:22.619248Z",
      "modelName": "gemini-2.5-pro",
      "provenance": null,
      "isOpenEnded": false,
      "protocolContext": null
    },
    "ENC-009": {
      "encounterName": "Post-Treatment Visits",
      "recurrenceKey": "FIXED_INTERVAL:1_weeks",
      "shouldExpand": false,
      "expandedCycles": [],
      "patternType": null,
      "cycleLengthDays": 63,
      "confidence": 0.0,
      "rationale": "The fixed interval 'P9W' (every 9 weeks) is an open-ended pattern. The protocol does not specify the maximum number of post-treatment visits, requiring human review.",
      "source": "cache",
      "requiresHumanReview": true,
      "reviewReason": "Open-ended pattern - protocol does not specify max visit count for 'P9W'.",
      "cachedAt": "2025-12-09T21:41:22.619267Z",
      "modelName": "gemini-2.5-pro",
      "provenance": null,
      "isOpenEnded": false,
      "protocolContext": null
    }
  },
  "discrepancies": [],
  "reviewItems": [],
  "metrics": {
    "encountersProcessed": 10,
    "encountersWithRecurrence": 3,
    "encountersExpanded": 1,
    "encountersCreated": 5,
    "encountersSkipped": 7,
    "saisProcessed": 81,
    "saisDuplicated": 1,
    "saisCreated": 70,
    "uniquePatternsAnalyzed": 0,
    "cacheHits": 3,
    "llmCalls": 0,
    "validationFlags": 0,
    "eventDrivenFlagged": 0,
    "reviewItemsCount": 0,
    "expansionRate": 0.333
  },
  "_agentDefinition": {
    "stageNumber": 8,
    "stageName": "Cycle Expansion",
    "displayName": "Treatment Cycle Generator",
    "purpose": "Expands repeating cycle patterns (e.g., 'Cycles 1-6, Day 1 of each 21-day cycle') into individual visit instances, enabling complete schedule generation.",
    "extractionMethodology": "Cycle pattern detection from visit/epoch headers. LLM interpretation of cycle descriptions (duration, repetition count). Visit instance generation with proper sequencing. Handling of variable cycle counts (until PD, max N cycles).",
    "keyOutputs": [
      {
        "field": "expandedEncounters",
        "description": "Individual visit instances for each cycle"
      },
      {
        "field": "cycleNumber",
        "description": "Cycle number (1, 2, 3, ...)"
      },
      {
        "field": "dayInCycle",
        "description": "Day within the cycle"
      },
      {
        "field": "cycleDuration",
        "description": "Length of each cycle in days"
      },
      {
        "field": "maxCycles",
        "description": "Maximum number of cycles or 'until progression'"
      },
      {
        "field": "cyclePattern",
        "description": "Description of the repeating pattern"
      }
    ],
    "downstreamIntegrations": [
      {
        "system": "EDC Build",
        "useCase": "Visit form instance generation",
        "automationType": "configuration",
        "fieldsUsed": [
          "expandedEncounters",
          "cycleNumber",
          "dayInCycle"
        ],
        "automationExample": "EDC generates C1D1, C1D8, C1D15, C2D1, C2D8... form instances automatically"
      },
      {
        "system": "IRT Build",
        "useCase": "Treatment supply forecasting per cycle",
        "automationType": "rule_generation",
        "fieldsUsed": [
          "maxCycles",
          "cycleDuration"
        ],
        "automationExample": "IRT calculates drug supply: 6 cycles x 21 days = 126 days supply per subject"
      },
      {
        "system": "CTMS",
        "useCase": "Expected visit count for enrollment planning",
        "automationType": "direct_mapping",
        "fieldsUsed": [
          "expandedEncounters",
          "maxCycles"
        ],
        "automationExample": "CTMS forecasts: 100 subjects x 6 cycles x 3 visits/cycle = 1800 expected visits"
      },
      {
        "system": "Patient Portal",
        "useCase": "Subject-facing visit schedule display",
        "automationType": "direct_mapping",
        "fieldsUsed": [
          "expandedEncounters",
          "cycleNumber",
          "dayInCycle"
        ],
        "automationExample": "Patient app shows: 'Your next visit: Cycle 3, Day 1 (approximately March 15)'"
      }
    ],
    "automationInsights": [
      {
        "insight": "Visit Generation",
        "description": "Cycle expansion creates complete EDC visit structure automatically"
      },
      {
        "insight": "Supply Planning",
        "description": "Cycle count drives drug and kit supply calculations"
      },
      {
        "insight": "Study Duration",
        "description": "Max cycles determine expected study duration for planning"
      }
    ],
    "dataQualityIndicators": [
      "cycle duration > 0",
      "max cycles is defined or 'until PD'",
      "day numbers are valid"
    ],
    "humanReviewTriggers": [
      "uncertain cycle count",
      "variable cycle duration",
      "complex termination criteria"
    ]
  }
}