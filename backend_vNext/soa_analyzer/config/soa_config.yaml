# SOA Extraction Pipeline Configuration
# Version: 1.0
# Purpose: Visit Schedule Planning

# ============================================================================
# PIPELINE STAGES
# ============================================================================
stages:
  # Stage 1: Page Detection (REQUIRED)
  detection:
    enabled: true
    model: "gemini-2.5-pro"
    cache_enabled: true

  # Stage 2: Protocol Classification (OPTIONAL)
  classification:
    enabled: true
    model: "claude-3-5-sonnet-20241022"

  # Stage 3: Evidence Synthesis (OPTIONAL)
  evidence:
    enabled: true
    model: "claude-3-5-sonnet-20241022"

  # Stage 4: Table Extraction (REQUIRED)
  extraction:
    enabled: true
    provider: "landingai"
    max_retries: 5
    retry_delay_base: 2  # seconds, exponential backoff

  # Stage 5: USDM Transformation + Enrichment (REQUIRED)
  transformation:
    enabled: true
    model: "claude-3-5-sonnet-20241022"
    enrichment_enabled: true

  # Stage 6: Quality Validation (REQUIRED)
  validation:
    enabled: true
    fail_on_threshold_breach: false  # Log warnings but continue

# ============================================================================
# QUALITY THRESHOLDS (5 Dimensions)
# ============================================================================
quality:
  accuracy:
    threshold: 0.95
    description: "No placeholders, valid formats, no hallucinations"
    checks:
      - no_placeholder_values
      - valid_date_formats
      - valid_time_formats
      - no_empty_required_fields

  completeness:
    threshold: 0.90
    description: "Required USDM fields present, activities mapped"
    checks:
      - required_usdm_fields
      - activity_coverage
      - encounter_coverage
      - timing_coverage

  compliance:
    threshold: 1.00  # Must be 100%
    description: "Valid against USDM 4.0 JSON schema"
    schema_path: "USDM_API.json"

  provenance:
    threshold: 0.95
    description: "Source page reference for extracted values"
    checks:
      - page_references_present
      - text_snippets_valid

  terminology:
    threshold: 0.90
    description: "Valid CDISC codes, OMOP mappings"
    checks:
      - cdisc_domain_valid
      - cdisc_code_valid
      - omop_concept_valid

# ============================================================================
# TERMINOLOGY MAPPING
# ============================================================================
terminology:
  cdisc:
    concepts_file: "config/cdisc_concepts.json"
    fuzzy_match_threshold: 0.85
    primary_domains:
      - LB  # Laboratory
      - VS  # Vital Signs
      - EG  # ECG
      - PE  # Physical Exam
      - QS  # Questionnaires
      - PR  # Procedures/Imaging
      - PC  # Pharmacokinetics
      - PP  # Pharmacodynamics

  omop:
    database_path: "athena_concepts_full.db"
    vocabularies:
      - LOINC      # Lab tests
      - SNOMED     # Procedures
      - RxNorm     # Drugs
    fuzzy_match_threshold: 0.80

# ============================================================================
# CACHING
# ============================================================================
cache:
  enabled: true
  directory: ".cache/soa"
  ttl_days: 30
  invalidation:
    - protocol_hash_change
    - config_change
    - prompt_change

# ============================================================================
# LLM CONFIGURATION
# ============================================================================
llm:
  anthropic:
    model: "claude-3-5-sonnet-20241022"
    max_tokens: 8192
    temperature: 0.0

  gemini:
    model: "gemini-2.5-pro"
    max_output_tokens: 65536

  azure_openai:  # Fallback
    deployment: "${AZURE_OPENAI_DEPLOYMENT}"
    api_version: "${AZURE_OPENAI_API_VERSION}"

# ============================================================================
# OUTPUT
# ============================================================================
output:
  usdm_file: "soa_usdm_4.0.json"
  enriched_file: "soa_enriched.json"
  quality_file: "soa_quality.json"
  provenance_file: "soa_provenance.json"

# ============================================================================
# LOGGING
# ============================================================================
logging:
  level: INFO
  file: "tmp/soa_pipeline.log"
  structured: true
