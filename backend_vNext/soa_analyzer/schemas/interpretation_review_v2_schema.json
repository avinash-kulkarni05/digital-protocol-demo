{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://protocol-digitalization.com/schemas/interpretation_review_v2.json",
  "title": "SOA Interpretation Review Schema v2.0",
  "description": "Rich interpretation review JSON showcasing LLM clinical reasoning, cross-protocol discoveries, and explainable AI with full provenance traceability",
  "type": "object",
  "required": ["schemaVersion", "protocolId", "generatedAt", "interpretationSteps", "reviewQueue"],
  "properties": {
    "schemaVersion": {
      "const": "2.0",
      "description": "Schema version identifier"
    },
    "protocolId": {
      "type": "string",
      "description": "Unique identifier for the protocol"
    },
    "protocolTitle": {
      "type": "string",
      "description": "Full title of the clinical trial protocol"
    },
    "generatedAt": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when this review was generated"
    },
    "clinicalInsightsSummary": {
      "$ref": "#/$defs/ClinicalInsightsSummary"
    },
    "interpretationSteps": {
      "type": "object",
      "description": "Detailed step-by-step interpretation results with clinical reasoning",
      "additionalProperties": {
        "$ref": "#/$defs/InterpretationStep"
      }
    },
    "protocolMiningDiscoveries": {
      "$ref": "#/$defs/ProtocolMiningDiscoveries"
    },
    "provenanceIndex": {
      "$ref": "#/$defs/ProvenanceIndex"
    },
    "reviewQueue": {
      "$ref": "#/$defs/ReviewQueue"
    },
    "stageSummary": {
      "$ref": "#/$defs/StageSummary"
    }
  },
  "$defs": {
    "ClinicalInsightsSummary": {
      "type": "object",
      "description": "Top-level AI-generated clinical insights and quality metrics",
      "properties": {
        "protocolComplexity": {
          "type": "object",
          "properties": {
            "treatmentCycles": {
              "type": "integer",
              "description": "Number of defined treatment cycles"
            },
            "maintenancePhase": {
              "type": "boolean",
              "description": "Whether protocol includes maintenance therapy"
            },
            "openEndedCycles": {
              "type": "array",
              "items": {"type": "string"},
              "description": "Cycles without fixed end (e.g., 'until progression')"
            },
            "totalUniqueVisits": {
              "type": "integer",
              "description": "Count of unique visit definitions"
            },
            "totalScheduledActivities": {
              "type": "integer",
              "description": "Total SAI count"
            },
            "conditionsDetected": {
              "type": "integer",
              "description": "Number of conditional rules found"
            },
            "alternativesDetected": {
              "type": "integer",
              "description": "Number of alternative choice points"
            }
          }
        },
        "keyDiscoveries": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/KeyDiscovery"
          },
          "description": "Most significant cross-protocol discoveries"
        },
        "openQuestions": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/OpenQuestion"
          },
          "description": "Questions requiring human input"
        },
        "qualityMetrics": {
          "type": "object",
          "properties": {
            "activitiesWithFullProvenance": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Proportion of activities with complete provenance"
            },
            "activitiesLinkedToModules": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Proportion linked to extraction modules"
            },
            "conditionsFullyInterpreted": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Proportion of conditions fully interpreted"
            },
            "aiConfidenceDistribution": {
              "type": "object",
              "properties": {
                "high": {"type": "integer"},
                "medium": {"type": "integer"},
                "low": {"type": "integer"}
              },
              "description": "Distribution of AI confidence levels"
            }
          }
        }
      }
    },
    "KeyDiscovery": {
      "type": "object",
      "required": ["id", "type", "finding"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^DISC-[0-9]+$",
          "description": "Unique discovery identifier"
        },
        "type": {
          "type": "string",
          "enum": ["CROSS_REFERENCE", "SAFETY_LINKAGE", "TIMING_DEPENDENCY", "SPECIMEN_CHAIN", "CONDITION_NETWORK"],
          "description": "Type of discovery"
        },
        "category": {
          "type": "string",
          "enum": ["SAFETY_CRITICAL", "EFFICACY", "PK_PD", "LABORATORY", "IMAGING", "PRO"],
          "description": "Clinical category"
        },
        "finding": {
          "type": "string",
          "description": "Human-readable finding description"
        },
        "linkedActivities": {
          "type": "array",
          "items": {"type": "string"},
          "description": "SAI IDs involved in this discovery"
        },
        "linkedModules": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Extraction modules providing context"
        },
        "clinicalReasoning": {
          "type": "string",
          "description": "LLM explanation of clinical significance"
        },
        "provenance": {
          "$ref": "#/$defs/ProvenanceRef"
        }
      }
    },
    "OpenQuestion": {
      "type": "object",
      "required": ["id", "question", "criticality"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^Q-[0-9]+$"
        },
        "question": {
          "type": "string",
          "description": "The question requiring human input"
        },
        "context": {
          "type": "string",
          "description": "Context from the protocol"
        },
        "recommendation": {
          "type": "string",
          "description": "AI recommendation if any"
        },
        "criticality": {
          "type": "string",
          "enum": ["HIGH", "MEDIUM", "LOW"]
        },
        "linkedReviewItem": {
          "type": "string",
          "description": "Reference to related review queue item"
        }
      }
    },
    "InterpretationStep": {
      "type": "object",
      "required": ["stepNumber", "title", "items"],
      "properties": {
        "stepNumber": {
          "type": "integer",
          "description": "Step number in the interpretation pipeline"
        },
        "title": {
          "type": "string",
          "description": "Human-readable step title"
        },
        "description": {
          "type": "string",
          "description": "What this step accomplishes"
        },
        "items": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/StepItem"
          }
        },
        "summary": {
          "type": "object",
          "properties": {
            "total": {"type": "integer"},
            "requiresReview": {"type": "integer"},
            "autoApproved": {"type": "integer"},
            "highConfidence": {"type": "integer"},
            "mediumConfidence": {"type": "integer"},
            "lowConfidence": {"type": "integer"}
          }
        }
      }
    },
    "StepItem": {
      "type": "object",
      "required": ["itemId", "status"],
      "properties": {
        "itemId": {
          "type": "string",
          "description": "Unique identifier for this item"
        },
        "activityId": {
          "type": "string",
          "description": "Related activity ID"
        },
        "activityName": {
          "type": "string",
          "description": "Human-readable activity name (denormalized)"
        },
        "visitId": {
          "type": "string",
          "description": "Related visit ID"
        },
        "visitName": {
          "type": "string",
          "description": "Human-readable visit name (denormalized)"
        },
        "status": {
          "type": "string",
          "enum": ["PENDING_REVIEW", "AUTO_APPROVED", "REQUIRES_INPUT", "FLAGGED"],
          "description": "Review status"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "AI confidence score (0-1)"
        },
        "proposal": {
          "type": "object",
          "description": "The proposed interpretation/change",
          "additionalProperties": true
        },
        "clinicalReasoning": {
          "type": "string",
          "description": "LLM explanation of why this interpretation was made"
        },
        "alternatives": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "option": {"type": "string"},
              "reasoning": {"type": "string"}
            }
          },
          "description": "Alternative interpretations considered"
        },
        "impactAssessment": {
          "type": "object",
          "properties": {
            "affectedVisits": {
              "type": "array",
              "items": {"type": "string"}
            },
            "affectedSAIs": {
              "type": "array",
              "items": {"type": "string"}
            },
            "scheduleComplexity": {
              "type": "string",
              "enum": ["LOW", "MEDIUM", "HIGH"]
            }
          },
          "description": "Impact of this decision on schedule"
        },
        "provenance": {
          "$ref": "#/$defs/ProvenanceRef"
        },
        "linkedModules": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Extraction modules providing context"
        }
      }
    },
    "ProtocolMiningDiscoveries": {
      "type": "object",
      "description": "Cross-module discoveries from Stage 9 Protocol Mining",
      "properties": {
        "totalActivitiesAnalyzed": {
          "type": "integer"
        },
        "activitiesWithDiscoveries": {
          "type": "integer"
        },
        "discoveryCategories": {
          "type": "object",
          "additionalProperties": {"type": "integer"},
          "description": "Count by category (laboratory, safety, pkpd, imaging, pro)"
        },
        "discoveries": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/MiningDiscovery"
          }
        }
      }
    },
    "MiningDiscovery": {
      "type": "object",
      "required": ["id", "activityId"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^MINE-[0-9]+$"
        },
        "activityId": {
          "type": "string"
        },
        "activityName": {
          "type": "string"
        },
        "domain": {
          "type": "string",
          "description": "CDISC domain code"
        },
        "linkedModules": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/ModuleLink"
          }
        },
        "clinicalInsight": {
          "type": "string",
          "description": "Overall clinical insight from cross-referencing"
        },
        "provenance": {
          "$ref": "#/$defs/ProvenanceRef"
        }
      }
    },
    "ModuleLink": {
      "type": "object",
      "required": ["module", "matchType", "confidence"],
      "properties": {
        "module": {
          "type": "string",
          "description": "Name of the extraction module"
        },
        "matchType": {
          "type": "string",
          "enum": ["DIRECT", "INDIRECT", "INFERRED"],
          "description": "How the match was established"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "enrichments": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Enrichment"
          }
        }
      }
    },
    "Enrichment": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["LAB_PANEL", "DOSE_MODIFICATION", "ENDPOINT_LINK", "PK_SAMPLING", "SAFETY_SIGNAL", "BIOMARKER"],
          "description": "Type of enrichment"
        },
        "details": {
          "type": "object",
          "additionalProperties": true,
          "description": "Type-specific enrichment details"
        },
        "provenance": {
          "$ref": "#/$defs/ProvenanceRef"
        }
      }
    },
    "ProvenanceIndex": {
      "type": "object",
      "description": "Index for UI highlighting and navigation",
      "properties": {
        "byPage": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {
              "$ref": "#/$defs/PageReference"
            }
          },
          "description": "Items indexed by PDF page number"
        },
        "byActivity": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {"type": "string"}
          },
          "description": "Review item IDs indexed by activity ID"
        },
        "bySection": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": {"type": "string"}
          },
          "description": "Item IDs indexed by protocol section"
        },
        "totalPages": {
          "type": "integer"
        },
        "totalSections": {
          "type": "integer"
        }
      }
    },
    "PageReference": {
      "type": "object",
      "properties": {
        "itemId": {
          "type": "string"
        },
        "type": {
          "type": "string",
          "description": "Item type (domain_mapping, activity_expansion, etc.)"
        },
        "snippet": {
          "type": "string",
          "maxLength": 200,
          "description": "Text snippet for UI display"
        }
      }
    },
    "ReviewQueue": {
      "type": "object",
      "description": "Priority-sorted, actionable review items",
      "properties": {
        "criticalItems": {
          "type": "array",
          "items": {"$ref": "#/$defs/ReviewQueueItem"},
          "description": "Items blocking schedule generation"
        },
        "highPriorityItems": {
          "type": "array",
          "items": {"$ref": "#/$defs/ReviewQueueItem"},
          "description": "Important but not blocking"
        },
        "mediumPriorityItems": {
          "type": "array",
          "items": {"$ref": "#/$defs/ReviewQueueItem"},
          "description": "Should review before finalization"
        },
        "lowPriorityItems": {
          "type": "array",
          "items": {"$ref": "#/$defs/ReviewQueueItem"},
          "description": "Optional review items"
        },
        "summary": {
          "type": "object",
          "properties": {
            "critical": {"type": "integer"},
            "high": {"type": "integer"},
            "medium": {"type": "integer"},
            "low": {"type": "integer"},
            "autoApproved": {"type": "integer"}
          }
        }
      }
    },
    "ReviewQueueItem": {
      "type": "object",
      "required": ["itemId", "step", "title"],
      "properties": {
        "itemId": {
          "type": "string"
        },
        "step": {
          "type": "string",
          "enum": ["DOMAIN_MAPPING", "ACTIVITY_EXPANSION", "ALTERNATIVES", "SPECIMENS", "CONDITIONS", "TIMING_CYCLES", "PROTOCOL_MINING"],
          "description": "Which interpretation step this belongs to"
        },
        "title": {
          "type": "string",
          "description": "Concise description of what needs review"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "impact": {
          "type": "string",
          "description": "Impact description (e.g., 'Affects 8 SAIs across 3 visits')"
        },
        "quickAction": {
          "$ref": "#/$defs/QuickAction"
        },
        "clinicalContext": {
          "type": "string",
          "description": "Clinical context for decision-making"
        },
        "provenance": {
          "$ref": "#/$defs/ProvenanceRef"
        }
      }
    },
    "QuickAction": {
      "type": "object",
      "description": "UI-friendly quick action options",
      "properties": {
        "type": {
          "type": "string",
          "enum": ["SINGLE_SELECT", "MULTI_SELECT", "NUMBER_INPUT", "TEXT_INPUT", "APPROVE_REJECT"],
          "description": "Type of input needed"
        },
        "options": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Available options for SELECT types"
        },
        "recommended": {
          "type": "string",
          "description": "AI-recommended option"
        },
        "recommendationReason": {
          "type": "string",
          "description": "Why this option is recommended"
        },
        "question": {
          "type": "string",
          "description": "Question for INPUT types"
        },
        "default": {
          "description": "Default value for INPUT types"
        },
        "hint": {
          "type": "string",
          "description": "Help text for the user"
        }
      }
    },
    "ProvenanceRef": {
      "type": "object",
      "description": "Reference to source location in protocol",
      "properties": {
        "pages": {
          "type": "array",
          "items": {"type": "integer"},
          "description": "PDF page numbers"
        },
        "pageNumber": {
          "type": "integer",
          "description": "Primary page number (for single-page refs)"
        },
        "sections": {
          "type": "array",
          "items": {"type": "string"},
          "description": "Protocol section references"
        },
        "tableRef": {
          "type": "string",
          "description": "Table reference (e.g., 'SOA-1')"
        },
        "footnoteRef": {
          "type": "string",
          "description": "Footnote reference (e.g., 'a', 'b')"
        },
        "textSnippet": {
          "type": "string",
          "maxLength": 500,
          "description": "Relevant text excerpt"
        },
        "source": {
          "type": "string",
          "description": "Source module name"
        }
      }
    },
    "StageSummary": {
      "type": "object",
      "description": "Summary of all interpretation stages",
      "properties": {
        "stagesCompleted": {
          "type": "array",
          "items": {"type": "integer"}
        },
        "stagesFailed": {
          "type": "array",
          "items": {"type": "integer"}
        },
        "totalProcessingTime": {
          "type": "number",
          "description": "Total time in seconds"
        },
        "lastStageCompleted": {
          "type": "integer"
        }
      }
    }
  }
}
