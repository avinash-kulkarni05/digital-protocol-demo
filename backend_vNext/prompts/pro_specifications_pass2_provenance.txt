system
You are an expert clinical trial document analyst specializing in locating exact source references in clinical protocol documents.

user
# PRO SPECIFICATIONS - PASS 2: PROVENANCE EXTRACTION

## OBJECTIVE
Add provenance (source references) to ALL values extracted in Pass 1. For EVERY extracted element, locate the supporting evidence in the protocol and add provenance.

You are provided with:
1. Extracted PRO/COA specifications from Pass 1
2. The original protocol PDF

Your task is to find EXACT source locations (provenance) for each extracted item.

---

## CRITICAL: 100% PROVENANCE COVERAGE REQUIRED

**EVERY section MUST have provenance coverage.** Provenance coverage means:
- The object has a `provenance` object with page_number and text_snippet

**FAILURE MODE**: If ANY section is missing a `provenance` object, the quality check FAILS.

**MANDATORY PROVENANCE OBJECTS** - You MUST add `provenance` to ALL these paths:
- `$.provenance` - Root document provenance (REQUIRED)
- `$.epro_system.provenance` (if epro_system is not null)
- `$.daily_diary.provenance` (if daily_diary is not null)
- `$.analysis_specifications.provenance` (if analysis_specifications is not null)

---

## PROVENANCE STRUCTURE

For each provenance object, provide:
```json
{
  "section_number": "8.3",
  "page_number": 75,
  "text_snippet": "Direct quote from protocol (max 500 chars)"
}
```

- **section_number**: SHORT section number ONLY (e.g., "7", "8.3"). MAX 20 characters. Can be null if unknown.
- **page_number**: PDF page number (integer, 1-indexed) - REQUIRED
- **text_snippet**: Direct quote from protocol (STRICT MAX 500 chars). Truncate with "..." if longer. - REQUIRED

---

## PASS 1 EXTRACTION (Data Requiring Provenance)

{{ extracted_values }}

---

## PROVENANCE PATHS TO POPULATE

**Root Level:**
- $.provenance

**PRO Instruments:**
- $.pro_instruments[*].provenance (EACH instrument)
- $.pro_instruments[*].administration.provenance (if present)
- $.pro_instruments[*].schedule.provenance (if present)
- $.pro_instruments[*].scoring.provenance (if present)
- $.pro_instruments[*].missing_data.provenance (if present)
- $.pro_instruments[*].training_requirements.provenance (if present)

**ePRO System:**
- $.epro_system.provenance (if epro_system is not null)
- $.epro_system.device_requirements.provenance (if device_requirements is not null)

**ClinRO Instruments:**
- $.clinro_instruments[*].provenance (EACH instrument)

**ObsRO Instruments:**
- $.obsro_instruments[*].provenance (EACH instrument)

**PerfO Instruments:**
- $.perfo_instruments[*].provenance (EACH instrument)

**Daily Diary:**
- $.daily_diary.provenance (if daily_diary is not null)

**Analysis Specifications:**
- $.analysis_specifications.provenance (if present)

**Biomedical Concepts:**
Note: biomedicalConcept objects do NOT require separate provenance. They inherit provenance from their parent instrument object.

---

## SEARCH STRATEGY

| Content Type | Typical Sections |
|--------------|------------------|
| PRO Instruments | 7, 8 (Assessments), Appendices |
| ePRO/eCOA System | 9 (Data Collection), 8 (Technology Systems) |
| ClinRO Scales | 7, 8 (Clinical Assessments, ECOG, Response) |
| Performance Tests | 7, 8 (Functional Assessments, 6MWT) |
| Daily Diary | 7, 8, Appendices (Patient Diary, Symptom Diary) |
| PRO Analysis | 11, 12 (Statistical Methods, PRO Endpoints) |
| Scoring/MCID | 11, 12, Appendices (Scoring Algorithms) |
| Missing Data | 11 (Missing Data Handling, Imputation) |
| Compliance | 7, 8 (Assessment Compliance, Monitoring) |
| Training | 8, 9 (Site Training, Patient Training) |

---

## TEXT SNIPPET RULES

1. **EXACT QUOTE**: Copy text exactly as it appears
2. **STRICT MAX 500 CHARACTERS**: If text exceeds 500 chars, TRUNCATE with "..." IMMEDIATELY
3. **MOST RELEVANT PORTION**: Select the SHORTEST phrase that directly supports the value
4. **CLEAN WHITESPACE**: Remove excess line breaks, collapse multiple spaces

---

## CRITICAL: DO NOT MODIFY PRIMITIVE ARRAYS

**Arrays that must remain as PLAIN STRING arrays:**
- `language_versions`: ["English", "Spanish"] ← KEEP AS PLAIN STRINGS
- `training_materials`: ["User guide"] ← KEEP AS PLAIN STRINGS
- `alert_triggers`: ["Missed assessment"] ← KEEP AS PLAIN STRINGS
- `items_collected`: ["Pain", "Fatigue"] ← KEEP AS PLAIN STRINGS
- `items_included`: ["Q1", "Q2"] ← KEEP AS PLAIN STRINGS
- `equipment_required`: ["Stopwatch"] ← KEEP AS PLAIN STRINGS
- `secondary_pro_endpoints`: ["Endpoint 1"] ← KEEP AS PLAIN STRINGS
- `statistical_methods`: ["MMRM"] ← KEEP AS PLAIN STRINGS
- `sensitivity_analyses`: ["Analysis 1"] ← KEEP AS PLAIN STRINGS
- `schedule` (when array): ["Baseline", "Week 12"] ← KEEP AS PLAIN STRINGS

**WRONG** (Do NOT do this):
```json
"language_versions": [
  {"value": "English", "provenance": {...}}  // WRONG!
]
```

**CORRECT** (Do this instead):
```json
"language_versions": ["English", "Spanish"],  // CORRECT - plain strings
// Provenance at PARENT object level only
```

---

## CRITICAL PAGE NUMBER RULES

1. Use PHYSICAL page numbers (1st page of PDF = 1)
2. Do NOT use printed page numbers in headers/footers
3. The text_snippet MUST appear on the EXACT page_number you specify

---

## OUTPUT FORMAT

Return the COMPLETE Pass 1 JSON with provenance added to ALL locations listed above.

Example structure:
```json
{
  "id": "PROTOCOL_ID-pro-specifications",
  "instanceType": "PROSpecifications",
  "name": "PROTOCOL_ID PRO Specifications",

  "pro_instruments": [
    {
      "instrument_id": "PRO-001",
      "instrument_name": "EORTC QLQ-C30",
      "instrument_type": "disease_specific",
      "administration": {
        "mode": "electronic",
        "device_type": "provisioned_tablet",
        "provenance": {
          "section_number": "8.3",
          "page_number": 75,
          "text_snippet": "The EORTC QLQ-C30 will be administered electronically via provisioned tablet..."
        }
      },
      "schedule": {
        "assessment_timepoints": [...],
        "recall_period": "past 7 days",
        "provenance": {
          "section_number": "8.3.1",
          "page_number": 76,
          "text_snippet": "The QLQ-C30 will be completed at baseline, Week 12, Week 24..."
        }
      },
      "scoring": {
        "mcid": "10 points",
        "provenance": {
          "section_number": "11.4",
          "page_number": 125,
          "text_snippet": "A 10-point change in Global Health Status is considered clinically meaningful..."
        }
      },
      "provenance": {
        "section_number": "8.3",
        "page_number": 75,
        "text_snippet": "The EORTC Quality of Life Questionnaire (QLQ-C30) version 3.0..."
      }
    }
  ],

  "epro_system": {
    "vendor_name": "ERT",
    "platform_name": "TrialMax",
    "provenance": {
      "section_number": "9.2",
      "page_number": 95,
      "text_snippet": "Electronic patient-reported outcomes will be collected using ERT TrialMax..."
    }
  },

  "daily_diary": {
    "required": true,
    "diary_name": "Daily Symptom Diary",
    "items_collected": ["Pain", "Fatigue", "Nausea"],
    "provenance": {
      "section_number": "8.5",
      "page_number": 80,
      "text_snippet": "Patients will complete a daily electronic symptom diary..."
    }
  },

  "analysis_specifications": {
    "primary_pro_endpoint": "Change from baseline in QLQ-C30 GHS at Week 24",
    "statistical_methods": ["MMRM"],
    "provenance": {
      "section_number": "11.4",
      "page_number": 125,
      "text_snippet": "The primary PRO endpoint is change from baseline in EORTC QLQ-C30..."
    }
  },

  "provenance": {
    "section_number": "8",
    "page_number": 70,
    "text_snippet": "PATIENT-REPORTED OUTCOMES AND CLINICAL ASSESSMENTS"
  }
}
```

---

## VALIDATION CHECKLIST (MANDATORY)

**Before returning, verify ALL of these provenance objects exist:**

Root Level:
- [ ] `$.provenance` exists with page_number and text_snippet

PRO Instruments (for EACH instrument in array):
- [ ] `$.pro_instruments[*].provenance` exists
- [ ] `$.pro_instruments[*].administration.provenance` exists (if administration is not null)
- [ ] `$.pro_instruments[*].schedule.provenance` exists (if schedule is not null)
- [ ] `$.pro_instruments[*].scoring.provenance` exists (if scoring is not null)

Other Instruments (for EACH in arrays):
- [ ] Every item in `clinro_instruments[]` has provenance
- [ ] Every item in `obsro_instruments[]` has provenance
- [ ] Every item in `perfo_instruments[]` has provenance

Optional Sections (if present and not null):
- [ ] `$.epro_system.provenance` exists
- [ ] `$.daily_diary.provenance` exists
- [ ] `$.analysis_specifications.provenance` exists

Format Requirements:
- [ ] All page_number values are integers (1-indexed)
- [ ] All text_snippets are ≤500 characters
- [ ] text_snippets are EXACT quotes from the document
- [ ] Primitive arrays remain as plain strings

**DO NOT RETURN until ALL checkboxes above are satisfied.**

---

## OUTPUT

Return ONLY valid JSON. No markdown fences, no explanations.
Return the complete merged JSON object with all Pass 1 data PLUS provenance for EVERY section.
