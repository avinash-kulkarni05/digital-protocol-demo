# LABORATORY SPECIFICATIONS - PASS 2: PROVENANCE EXTRACTION
# Purpose: Find exact source locations for previously extracted values
# CRITICAL: Do NOT change any values - only add provenance objects

You are locating the exact source of previously extracted laboratory specification values in the protocol document.

## PASS 2 INSTRUCTION

You are given:
1. The original protocol document
2. Previously extracted values from Pass 1 (see EXTRACTED_VALUES below)

Your task: Find the EXACT location in the document where each value was found and add provenance.

## CRITICAL: OUTPUT SIZE MANAGEMENT

This module generates large output. To prevent JSON truncation:
1. Keep text_snippets SHORT (≤150 chars preferred, ≤500 max)
2. Use concise wording in all fields
3. Do not duplicate text across multiple provenance objects
4. Focus on KEY information, not every detail

## PROVENANCE REQUIREMENTS

For each provenance object, provide:
- section_number: Section number from document (e.g., "8.1", "9.3.2", "5.2")
- page_number: Exact PDF page number (integer, 1-indexed)
- text_snippet: Direct quote from source (≤150 chars preferred, MAX 500 chars)

## PROVENANCE PATHS TO POPULATE

Add provenance to these locations in the JSON:

### Root Level
- $.provenance (overall laboratory specifications section)

### Central Laboratory
- $.central_laboratory.provenance

### Discovered Panels
For each item in discovered_panels array:
- $.discovered_panels[*].provenance

### Laboratory Tests
For each item in laboratory_tests array:
- $.laboratory_tests[*].provenance

### Testing Schedule
For each item in testing_schedule array:
- $.testing_schedule[*].provenance

### Sample Collection Requirements
- $.sample_collection_requirements.provenance

### Lab-Based Dose Modifications
For each item in lab_based_dose_modifications array:
- $.lab_based_dose_modifications[*].provenance

### Eligibility Lab Criteria
For each item in eligibility_lab_criteria array:
- $.eligibility_lab_criteria[*].provenance

### Critical Value Reporting
- $.critical_value_reporting.provenance

### Abnormal Result Grading
- $.abnormal_result_grading.provenance

### Pregnancy Testing
- $.pregnancy_testing.provenance

### PK Samples
- $.pharmacokinetic_samples.provenance

### Biomarker Samples
- $.biomarker_samples.provenance

### Local Lab Requirements
- $.local_lab_requirements.provenance

### Biomedical Concepts
Note: biomedicalConcept objects do NOT require separate provenance. They inherit provenance from their parent panel or test object.

## SEARCH STRATEGY

For each section, search the protocol for the exact text that supports the extracted values:

1. **Discovered Panels**: Look in "Laboratory Assessments", "Safety Assessments", SOA tables
2. **Laboratory Tests**: Look in "Laboratory Tests", "Safety Laboratories", appendices with test lists
3. **Testing Schedule**: Look in "Schedule of Activities", "Schedule of Events", "Assessment Schedule"
4. **Sample Collection**: Look in "Sample Collection", "Specimen Handling", "Laboratory Manual"
5. **Dose Modifications**: Look in "Dose Modifications", "Dose Adjustments", "Toxicity Management"
6. **Eligibility Criteria**: Look in "Inclusion Criteria", "Exclusion Criteria", "Eligibility"
7. **Critical Values**: Look in "Critical Values", "Alert Reporting", "Laboratory Abnormalities"
8. **Pregnancy Testing**: Look in "Pregnancy Testing", "Women of Childbearing Potential", "WOCBP"
9. **PK Samples**: Look in "Pharmacokinetics", "PK Sampling", "Blood Sampling for PK"
10. **Biomarkers**: Look in "Biomarkers", "Exploratory Objectives", "Correlative Studies"

## CRITICAL: DO NOT MODIFY PRIMITIVE ARRAYS

**IMPORTANT**: The following array fields contain PLAIN STRINGS. Do NOT convert them to objects with value/provenance.

**Arrays that must remain as PLAIN STRING arrays:**
- `accreditations`: ["CAP", "CLIA"] ← KEEP AS PLAIN STRINGS
- `analytes`: ["Study drug", "Metabolite"] ← KEEP AS PLAIN STRINGS
- `allowed_tests`: ["Pregnancy testing", "Urgent labs"] ← KEEP AS PLAIN STRINGS
- `notification_recipients`: ["Investigator", "Medical monitor"] ← KEEP AS PLAIN STRINGS
- `timepoints` (when string array): ["Screening", "Day 1", "Week 4"] ← KEEP AS PLAIN STRINGS

**WRONG** (Do NOT do this):
```json
"accreditations": [
  {"value": "CAP", "provenance": {...}},
  {"value": "CLIA", "provenance": {...}}
]
```

**CORRECT** (Do this instead):
```json
"accreditations": ["CAP", "CLIA"],
"provenance": {
  "section_number": "8.1",
  "page_number": 55,
  "text_snippet": "Central laboratory maintains CAP and CLIA accreditation..."
}
```

Provenance goes at the PARENT OBJECT level, covering all fields within that object including string arrays.

---

## TEXT SNIPPET RULES - STRICTLY ENFORCED

**CRITICAL: text_snippet MUST be ≤500 characters. This is a HARD schema limit.**

1. Quote EXACTLY from the document
2. **MAXIMUM 500 characters - NEVER exceed this limit**
3. If the relevant text is longer, select the SHORTEST portion that supports the value
4. Truncate with "..." if needed to stay under 500 chars
5. Do not include full tables or multi-line content
6. Focus on the SINGLE MOST RELEVANT sentence or phrase

**WRONG** (too long - will fail schema validation):
```json
"text_snippet": "Table 10.1: Clinical Laboratory Tests\nTest Analytes\nHematology hemoglobin\nhematocrit\nplatelet count\nred blood cell count\nWBC count..."
```

**CORRECT** (concise, under 150 chars):
```json
"text_snippet": "Hematology panel includes hemoglobin, hematocrit, platelet count, RBC, WBC..."
```

Count characters BEFORE returning. Keep under 150 when possible, MAX 500.

## PREVIOUSLY EXTRACTED VALUES

{{ extracted_values }}

## OUTPUT FORMAT

Return the COMPLETE JSON with provenance added to each applicable location.

Example structure:

```json
{
  "id": "LS-001",
  "instanceType": "LaboratorySpecifications",
  "name": "Laboratory Specifications",
  "description": "Protocol-discovered laboratory testing requirements",
  
  "central_laboratory": {
    "vendor_name": "Central Lab Inc",
    "accreditations": ["CAP", "CLIA"],
    "data_transfer_method": "Electronic via secure portal",
    "provenance": {
      "section_number": "8.1",
      "page_number": 55,
      "text_snippet": "Central laboratory services will be provided by Central Lab Inc, which maintains CAP and CLIA..."
    }
  },
  
  "discovered_panels": [
    {
      "panel_id": "PNL-001",
      "panel_name": "Hematology Panel",
      "panel_code": "58410-2",
      "panel_description": "Complete blood count with differential",
      "panel_category": "hematology",
      "test_count": 8,
      "provenance": {
        "section_number": "8.1.1",
        "page_number": 56,
        "text_snippet": "Hematology Panel: Complete blood count with differential including hemoglobin, hematocrit..."
      }
    }
  ],
  
  "laboratory_tests": [
    {
      "test_id": "LAB-001",
      "test_name": "Hemoglobin",
      "test_code": "718-7",
      "panel_ref": "PNL-001",
      "specimen_type": "whole_blood",
      "collection_container": "EDTA lavender top",
      "collection_volume": "3 mL",
      "fasting_required": false,
      "unit": "g/dL",
      "reference_ranges": [
        {"low": 12.0, "high": 16.0, "unit": "g/dL", "population": "adult_female"},
        {"low": 13.5, "high": 17.5, "unit": "g/dL", "population": "adult_male"}
      ],
      "critical_values": [
        {"type": "low", "value": 7.0, "unit": "g/dL", "action_required": "Immediate notification to investigator"}
      ],
      "provenance": {
        "section_number": "8.1.1",
        "page_number": 56,
        "text_snippet": "Hemoglobin will be measured using EDTA whole blood (3 mL lavender top tube)..."
      }
    }
  ],
  
  "testing_schedule": [
    {
      "schedule_id": "SCH-001",
      "test_or_panel_ref": "PNL-001",
      "timepoints": [
        {"timepoint_name": "Screening", "timepoint_type": "screening"},
        {"timepoint_name": "Cycle 1 Day 1", "timepoint_type": "baseline"},
        {"timepoint_name": "Every 3 weeks", "timepoint_type": "treatment"}
      ],
      "frequency": "At screening and every 3 weeks during treatment",
      "provenance": {
        "section_number": "1.3",
        "page_number": 22,
        "text_snippet": "Hematology panel will be performed at screening, Cycle 1 Day 1, and every 3 weeks..."
      }
    }
  ],
  
  "sample_collection_requirements": {
    "fasting_requirements": "Fasting not required for hematology; 8-hour fast for lipid panel",
    "timing_requirements": "Predose on dosing days",
    "processing_requirements": "Process within 2 hours of collection",
    "storage_requirements": "Store at 2-8°C until shipment",
    "shipping_requirements": "Ship on cold packs within 24 hours",
    "provenance": {
      "section_number": "8.1.4",
      "page_number": 60,
      "text_snippet": "Samples should be collected predose on dosing days. Fasting is not required for hematology..."
    }
  },
  
  "lab_based_dose_modifications": [
    {
      "modification_id": "MOD-001",
      "parameter_name": "Absolute Neutrophil Count (ANC)",
      "trigger_condition": "ANC <1000/μL",
      "operator": "lt",
      "threshold_value": 1000,
      "threshold_unit": "/μL",
      "reference_type": "absolute",
      "required_action": "Hold treatment until ANC ≥1500/μL, then resume at reduced dose",
      "recovery_criteria": "ANC ≥1500/μL for at least 7 days",
      "provenance": {
        "section_number": "6.5.2",
        "page_number": 48,
        "text_snippet": "For ANC <1000/μL, hold treatment. Resume at reduced dose when ANC ≥1500/μL..."
      }
    }
  ],
  
  "eligibility_lab_criteria": [
    {
      "criteria_id": "ELIG-001",
      "criteria_type": "inclusion",
      "parameter_name": "Hemoglobin",
      "condition": "Hemoglobin ≥9.0 g/dL",
      "operator": "gte",
      "threshold_value": 9.0,
      "threshold_unit": "g/dL",
      "provenance": {
        "section_number": "5.1",
        "page_number": 30,
        "text_snippet": "Adequate bone marrow function defined as: Hemoglobin ≥9.0 g/dL..."
      }
    }
  ],
  
  "critical_value_reporting": {
    "notification_timeline": "Within 24 hours",
    "notification_recipients": ["Site investigator", "Medical monitor"],
    "documentation_requirements": "Document in source and eCRF within 24 hours",
    "critical_value_list": [
      {"parameter": "Hemoglobin", "critical_low": 7.0, "critical_high": null, "unit": "g/dL", "clinical_action": "Hold treatment, evaluate for transfusion"}
    ],
    "provenance": {
      "section_number": "8.1.5",
      "page_number": 62,
      "text_snippet": "Critical laboratory values must be reported to the investigator and medical monitor within 24..."
    }
  },
  
  "abnormal_result_grading": {
    "grading_system": "CTCAE",
    "grading_version": "v5.0",
    "clinically_significant_threshold": "Grade 2 or higher",
    "ae_reporting_threshold": "Grade 3 or higher",
    "provenance": {
      "section_number": "8.2",
      "page_number": 65,
      "text_snippet": "Laboratory abnormalities will be graded according to CTCAE v5.0. Grade 3 or higher abnormalities..."
    }
  },
  
  "pregnancy_testing": {
    "required": true,
    "applicable_population": "Women of childbearing potential",
    "test_type": "Serum beta-hCG",
    "timing": "At screening, prior to each cycle, and at end of treatment",
    "sensitivity": "≤25 mIU/mL",
    "action_if_positive": "Immediately discontinue study treatment and follow pregnancy reporting procedures",
    "provenance": {
      "section_number": "8.1.3",
      "page_number": 58,
      "text_snippet": "Women of childbearing potential must have a negative serum pregnancy test (beta-hCG, sensitivity..."
    }
  },
  
  "pharmacokinetic_samples": {
    "pk_sampling_required": true,
    "analytes": ["Study drug", "Active metabolite"],
    "sample_type": "plasma",
    "timepoints_description": "Predose and 1, 2, 4, 8 hours post-dose on Cycle 1 Day 1 and Day 15",
    "volume_per_sample": "4 mL",
    "processing_requirements": "Centrifuge within 30 minutes, store at -70°C",
    "provenance": {
      "section_number": "8.3",
      "page_number": 68,
      "text_snippet": "PK samples (4 mL plasma) will be collected predose and at 1, 2, 4, and 8 hours post-dose on..."
    }
  },
  
  "biomarker_samples": {
    "biomarker_sampling_required": true,
    "biomarkers": [
      {"name": "Circulating tumor DNA", "purpose": "Exploratory response assessment", "sample_type": "plasma", "timing": "Baseline, Cycle 3, End of Treatment"}
    ],
    "optional_consent_required": true,
    "provenance": {
      "section_number": "8.4",
      "page_number": 70,
      "text_snippet": "Optional biomarker samples for circulating tumor DNA analysis will be collected with separate..."
    }
  },
  
  "local_lab_requirements": {
    "local_lab_allowed": true,
    "allowed_tests": ["Urgent safety labs", "Pregnancy testing"],
    "certification_requirements": "CAP or CLIA certified",
    "provenance": {
      "section_number": "8.1.6",
      "page_number": 63,
      "text_snippet": "Local laboratories may be used for urgent safety assessments. Local labs must be CAP or CLIA..."
    }
  },
  
  "extraction_statistics": {
    "total_panels_discovered": 3,
    "total_tests_discovered": 25,
    "total_schedule_entries": 5,
    "dose_modification_rules": 8,
    "eligibility_criteria_count": 12,
    "critical_values_defined": 6
  },
  
  "provenance": {
    "section_number": "8",
    "page_number": 55,
    "text_snippet": "LABORATORY ASSESSMENTS - All laboratory assessments will be performed by the central laboratory..."
  }
}
```

## VALIDATION CHECKLIST (MANDATORY)

**Before returning, verify ALL of these provenance objects exist:**

Root Level:
- [ ] `$.provenance` exists with page_number and text_snippet

Section Level:
- [ ] `$.central_laboratory.provenance` exists (if central_laboratory is not null)
- [ ] `$.sample_collection_requirements.provenance` exists (if not null)
- [ ] `$.critical_value_reporting.provenance` exists (if not null)
- [ ] `$.abnormal_result_grading.provenance` exists (if not null)
- [ ] `$.pregnancy_testing.provenance` exists (if not null)
- [ ] `$.pharmacokinetic_samples.provenance` exists (if not null)
- [ ] `$.biomarker_samples.provenance` exists (if not null)
- [ ] `$.local_lab_requirements.provenance` exists (if not null)

Array Items:
- [ ] Every item in `discovered_panels[]` has provenance
- [ ] Every item in `laboratory_tests[]` has provenance
- [ ] Every item in `testing_schedule[]` has provenance
- [ ] Every item in `lab_based_dose_modifications[]` has provenance
- [ ] Every item in `eligibility_lab_criteria[]` has provenance

Format Requirements:
- [ ] All page_number values are integers (1-indexed)
- [ ] All text_snippets are ≤500 characters (prefer ≤150)
- [ ] text_snippets are EXACT quotes from the document
- [ ] Primitive arrays remain as plain strings (accreditations, analytes, allowed_tests, notification_recipients)
- [ ] No values were modified from Pass 1
- [ ] Output is complete, valid JSON (no truncation)

**DO NOT RETURN until ALL checkboxes above are satisfied.**

Return ONLY valid JSON. No markdown fences.
