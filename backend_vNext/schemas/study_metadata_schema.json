{
  "type": "object",
  "description": "USDM 4.0-compliant schema for StudyDefinition extraction with enhanced Study Arms, Population, and Milestones. Version 2 with enhanced provenance.",
  "properties": {
    "schemaVersion": {
      "type": "string",
      "const": "2.0",
      "description": "Schema version for migration compatibility"
    },
    "sourceDocument": {
      "type": "object",
      "description": "Immutable document fingerprint for regulatory traceability",
      "properties": {
        "documentId": {
          "type": "string",
          "description": "Unique document identifier (typically SHA256 hash)"
        },
        "filename": {
          "type": "string",
          "description": "Original filename of the uploaded document"
        },
        "sha256Hash": {
          "type": "string",
          "description": "SHA256 hash of document content for integrity verification",
          "pattern": "^[a-f0-9]{64}$"
        },
        "byteSize": {
          "type": "integer",
          "description": "Document size in bytes",
          "minimum": 1
        },
        "uploadTimestamp": {
          "type": "string",
          "description": "ISO 8601 timestamp when document was uploaded",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}"
        },
        "pageCount": {
          "type": "integer",
          "description": "Total number of pages in document",
          "minimum": 1
        }
      },
      "required": ["documentId", "filename", "sha256Hash", "uploadTimestamp"],
      "additionalProperties": false
    },
    "id": {
      "type": "string",
      "description": "Protocol number - primary study identifier",
      "minLength": 1,
      "maxLength": 50
    },
    "instanceType": {
      "type": "string",
      "enum": ["Study"],
      "description": "USDM resource type - MUST be 'Study'"
    },
    "name": {
      "type": "string",
      "description": "Protocol short name or acronym",
      "minLength": 1,
      "maxLength": 150
    },
    "officialTitle": {
      "type": "string",
      "description": "Full official protocol title",
      "minLength": 1,
      "maxLength": 500
    },
    "version": {
      "type": "string",
      "description": "Protocol version number",
      "minLength": 1,
      "maxLength": 20
    },
    "studyPhase": {
      "$ref": "#/$defs/studyPhaseCode",
      "description": "Study phase as USDM Code object with NCI Thesaurus code - enforced code-decode pairs"
    },
    "studyType": {
      "$ref": "#/$defs/studyTypeCode",
      "description": "Study type as USDM Code object with NCI Thesaurus code - enforced code-decode pairs"
    },
    "studyIdentifiers": {
      "type": "array",
      "description": "Array of all study identifiers (NCT, EudraCT, IND, etc.)",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Identifier value"
          },
          "scopeId": {
            "type": "string",
            "description": "Identifier scope/registry (case-insensitive)",
            "enum": [
              "clinicaltrials.gov",
              "ClinicalTrials.gov",
              "eudract",
              "EudraCT",
              "fda_ind",
              "IND",
              "FDA_IND",
              "sponsor",
              "Sponsor",
              "other",
              "Other"
            ]
          },
          "provenance": {
            "$ref": "#/$defs/provenance"
          }
        },
        "required": ["id", "scopeId", "provenance"],
        "additionalProperties": false
      },
      "minItems": 1
    },
    "studyProtocolVersions": {
      "type": "array",
      "description": "Protocol version history",
      "items": {
        "type": "object",
        "properties": {
          "versionNumber": {
            "type": "string"
          },
          "versionDate": {
            "type": "string",
            "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
            "description": "ISO date format YYYY-MM-DD"
          },
          "amendmentNumber": {
            "type": "string"
          },
          "provenance": {
            "$ref": "#/$defs/provenance"
          }
        },
        "required": ["versionNumber", "versionDate", "provenance"],
        "additionalProperties": false
      },
      "minItems": 1
    },
    "studyPopulation": {
      "type": "object",
      "description": "Population characteristics for site feasibility",
      "properties": {
        "targetDisease": {
          "type": "object",
          "description": "Disease/condition being studied",
          "properties": {
            "name": {
              "type": "string",
              "description": "Disease name",
              "maxLength": 150
            },
            "stage": {
              "type": "string",
              "description": "Disease stage/severity",
              "maxLength": 100
            },
            "histology": {
              "type": "string",
              "description": "Histological classification",
              "maxLength": 100
            },
            "meddraCode": {
              "type": "string",
              "description": "MedDRA preferred term code"
            },
            "icdCode": {
              "type": "string",
              "description": "ICD-10 code"
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "required": ["name"],
          "additionalProperties": false
        },
        "ageRange": {
          "type": "object",
          "description": "Age eligibility criteria",
          "properties": {
            "minAge": {
              "type": "integer",
              "description": "Minimum age",
              "minimum": 0
            },
            "maxAge": {
              "type": ["integer", "null"],
              "description": "Maximum age (null if no limit)",
              "minimum": 0
            },
            "maxAgeNoLimit": {
              "type": "boolean",
              "description": "True if no upper age limit"
            },
            "unit": {
              "type": "string",
              "enum": ["years", "months", "weeks", "days"],
              "description": "Age unit"
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "required": ["minAge", "unit"],
          "additionalProperties": false
        },
        "sex": {
          "type": "object",
          "description": "Sex eligibility",
          "properties": {
            "allowed": {
              "type": "array",
              "description": "Allowed sex values with NCI codes - enforced code-decode pairs",
              "items": {
                "$ref": "#/$defs/sexCode"
              },
              "minItems": 1,
              "maxItems": 2
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "required": ["allowed"],
          "additionalProperties": false
        },
        "priorTherapyRequirements": {
          "type": "object",
          "description": "Prior treatment requirements",
          "properties": {
            "required": {
              "type": "array",
              "description": "Required prior therapies",
              "items": {
                "type": "string"
              }
            },
            "minPriorLines": {
              "type": "integer",
              "description": "Minimum prior lines of therapy",
              "minimum": 0
            },
            "maxPriorLines": {
              "type": "integer",
              "description": "Maximum prior lines of therapy",
              "minimum": 0
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "additionalProperties": false
        },
        "biomarkerRequirements": {
          "type": "array",
          "description": "Required biomarker status",
          "items": {
            "type": "object",
            "properties": {
              "name": {
                "type": "string",
                "description": "Biomarker name"
              },
              "requirement": {
                "type": "string",
                "description": "Required status/value"
              },
              "testingRequired": {
                "type": "boolean",
                "description": "Is testing required for eligibility"
              },
              "provenance": {
                "$ref": "#/$defs/provenance"
              }
            },
            "required": ["name", "requirement", "testingRequired"],
            "additionalProperties": false
          }
        },
        "performanceStatus": {
          "type": "object",
          "description": "Functional status requirements",
          "properties": {
            "scale": {
              "type": "string",
              "enum": ["ECOG", "Karnofsky"],
              "description": "Performance status scale"
            },
            "allowedValues": {
              "type": "array",
              "description": "Allowed numeric values",
              "items": {
                "type": "integer"
              },
              "minItems": 1
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "required": ["scale", "allowedValues"],
          "additionalProperties": false
        },
        "keyInclusionSummary": {
          "$ref": "#/$defs/textArrayWithProvenance",
          "description": "Top 4-6 key inclusion criteria with integrated provenance"
        },
        "keyExclusionSummary": {
          "$ref": "#/$defs/textArrayWithProvenance",
          "description": "Top 4-6 key exclusion criteria with integrated provenance"
        },
        "estimatedScreenFailureRate": {
          "type": "number",
          "description": "Estimated screen failure rate as decimal (0.0-1.0)",
          "minimum": 0,
          "maximum": 1
        },
        "screenFailureRateMethod": {
          "type": "string",
          "description": "How rate was determined (stated vs estimated)",
          "maxLength": 200
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": [
        "targetDisease",
        "ageRange",
        "sex",
        "keyInclusionSummary",
        "keyExclusionSummary",
        "provenance"
      ],
      "additionalProperties": false
    },
    "studyMilestones": {
      "type": "object",
      "description": "Key dates and durations for project planning",
      "properties": {
        "studyStartDate": {
          "$ref": "#/$defs/milestoneDate",
          "description": "First site activated"
        },
        "firstSubjectScreened": {
          "$ref": "#/$defs/milestoneDate",
          "description": "First subject signed ICF"
        },
        "firstSubjectRandomized": {
          "$ref": "#/$defs/milestoneDate",
          "description": "First subject randomized/enrolled"
        },
        "enrollmentCompletionDate": {
          "$ref": "#/$defs/milestoneDate",
          "description": "Last subject enrolled/randomized"
        },
        "primaryCompletionDate": {
          "$ref": "#/$defs/milestoneDate",
          "description": "Primary endpoint data collection complete"
        },
        "studyCompletionDate": {
          "$ref": "#/$defs/milestoneDate",
          "description": "Final subject final visit"
        },
        "estimatedDurations": {
          "type": "object",
          "description": "Numeric duration values",
          "properties": {
            "screeningPeriodDays": {
              "type": "integer",
              "description": "Screening window in days",
              "minimum": 1
            },
            "enrollmentPeriodMonths": {
              "type": "integer",
              "description": "Enrollment period in months",
              "minimum": 1
            },
            "treatmentPeriodDescription": {
              "type": "string",
              "description": "Treatment duration description",
              "maxLength": 500
            },
            "followUpPeriodMonths": {
              "type": "integer",
              "description": "Follow-up period in months",
              "minimum": 0
            },
            "totalStudyDurationMonths": {
              "type": "integer",
              "description": "Total study duration in months",
              "minimum": 1
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "additionalProperties": false
        },
        "interimAnalyses": {
          "type": "array",
          "description": "Planned interim analyses",
          "items": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "description": "Unique identifier (IA1, IA2...)",
                "maxLength": 50
              },
              "name": {
                "type": "string",
                "description": "Descriptive name",
                "maxLength": 150
              },
              "timing": {
                "type": "string",
                "description": "When analysis occurs",
                "maxLength": 100
              },
              "plannedEventCount": {
                "type": "integer",
                "description": "Number of events triggering analysis",
                "minimum": 1
              },
              "purpose": {
                "type": "string",
                "description": "Analysis purpose",
                "enum": [
                  "Futility",
                  "Efficacy",
                  "Futility and efficacy",
                  "Safety",
                  "Other"
                ]
              },
              "alphaSpent": {
                "type": "number",
                "description": "Alpha allocated to this analysis",
                "minimum": 0,
                "maximum": 1
              },
              "stoppingBoundary": {
                "type": "string",
                "description": "Stopping boundary method",
                "enum": [
                  "O'Brien-Fleming",
                  "Pocock",
                  "Haybittle-Peto",
                  "Lan-DeMets",
                  "Other"
                ]
              },
              "provenance": {
                "$ref": "#/$defs/provenance"
              }
            },
            "required": ["id", "name", "timing", "purpose", "provenance"],
            "additionalProperties": false
          }
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["estimatedDurations", "provenance"],
      "additionalProperties": false
    },
    "studyDesignInfo": {
      "type": "object",
      "description": "Study design metadata",
      "properties": {
        "designType": {
          "type": "string",
          "description": "Study design type",
          "enum": [
            "Parallel Assignment",
            "Crossover Assignment",
            "Sequential Assignment",
            "Single Group Assignment",
            "Factorial Assignment"
          ]
        },
        "randomization": {
          "type": "object",
          "description": "Randomization details",
          "properties": {
            "isRandomized": {
              "type": "boolean",
              "description": "Is study randomized"
            },
            "allocationRatio": {
              "type": "string",
              "description": "Allocation ratio (e.g., '1:1', '2:1')"
            },
            "allocationMethod": {
              "type": "string",
              "description": "Method of allocation (IWRS, etc.)"
            },
            "blockSize": {
              "type": "string",
              "description": "Randomization block size"
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "additionalProperties": false
        },
        "blinding": {
          "type": "object",
          "description": "Blinding/masking details",
          "properties": {
            "blindingType": {
              "type": "string",
              "description": "Type of blinding",
              "enum": [
                "Open-label",
                "Single-blind",
                "Double-blind",
                "Triple-blind",
                "Quadruple-blind"
              ]
            },
            "whoIsBlinded": {
              "type": "array",
              "description": "Who is blinded",
              "items": {
                "type": "string",
                "enum": [
                  "Participant",
                  "Investigator",
                  "Outcomes Assessor",
                  "Caregiver"
                ]
              }
            },
            "provenance": {
              "$ref": "#/$defs/provenance"
            }
          },
          "additionalProperties": false
        },
        "targetEnrollment": {
          "type": "integer",
          "description": "Total target enrollment",
          "minimum": 1
        },
        "plannedSites": {
          "type": "integer",
          "description": "Number of planned sites",
          "minimum": 1
        },
        "countries": {
          "$ref": "#/$defs/textArrayWithProvenance",
          "description": "List of participating countries (NOT regions) with integrated provenance"
        },
        "countryInferenceMethod": {
          "type": "string",
          "description": "Method used to infer countries from regions (if applicable)",
          "maxLength": 500
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["provenance"],
      "additionalProperties": false
    },
    "therapeuticArea": {
      "$ref": "#/$defs/textWithProvenance",
      "description": "Primary therapeutic area with integrated provenance"
    },
    "indication": {
      "$ref": "#/$defs/textWithProvenance",
      "description": "Specific disease or condition with integrated provenance"
    },
    "sponsorName": {
      "$ref": "#/$defs/textWithProvenance",
      "description": "Legal sponsor entity name with integrated provenance"
    },
    "isPivotal": {
      "type": "boolean",
      "description": "Is this a pivotal/registration study"
    },
    "provenance": {
      "$ref": "#/$defs/provenance",
      "description": "Root-level provenance for protocol identification"
    },
    "extensionAttributes": {
      "type": "array",
      "description": "USDM extension attributes for non-standard fields (ich_m11_section, extractionMetadata only)",
      "items": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "enum": ["ich_m11_section", "extractionMetadata"]
          },
          "value": {}
        },
        "required": ["name", "value"],
        "additionalProperties": false
      }
    },
    "_metadata": {
      "type": "object",
      "description": "System metadata added by extraction pipeline (not part of domain schema)",
      "properties": {
        "module_id": { "type": "string" },
        "instance_type": { "type": "string" },
        "pass1_duration_seconds": { "type": "number" },
        "pass2_duration_seconds": { "type": "number" },
        "quality_score": { "type": "object" }
      }
    }
  },
  "required": [
    "id",
    "instanceType",
    "name",
    "officialTitle",
    "version",
    "studyPhase",
    "studyType",
    "studyIdentifiers",
    "studyProtocolVersions",
    "studyPopulation",
    "studyMilestones",
    "therapeuticArea",
    "indication",
    "sponsorName",
    "provenance",
    "extensionAttributes"
  ],
  "$defs": {
    "provenance": {
      "type": "object",
      "description": "Source tracking for extracted data with verification status. Text_snippet is used for PDF highlighting.",
      "properties": {
        "section_number": {
          "type": ["string", "null"],
          "description": "Protocol section number (e.g., '1.1', '6.2.1'). Can be null if data is from cover page or appendix."
        },
        "page_number": {
          "type": "integer",
          "description": "Page number in protocol where evidence appears",
          "minimum": 1
        },
        "text_snippet": {
          "type": "string",
          "description": "EXACT direct quote from protocol containing the extracted value. Used for text-based PDF highlighting (â‰¤500 chars)",
          "maxLength": 500,
          "minLength": 10
        },
        "char_start": {
          "type": "integer",
          "description": "Character offset start position on page (optional, for precise highlighting)",
          "minimum": 0
        },
        "char_end": {
          "type": "integer",
          "description": "Character offset end position on page (optional, for precise highlighting)",
          "minimum": 0
        },
        "verification_status": {
          "type": "string",
          "description": "Verification result from provenance verifier",
          "enum": ["verified", "verified_adjacent_page", "unverified", "pending"]
        },
        "confidence_score": {
          "type": "integer",
          "description": "Fuzzy match confidence score as percentage (0-100)",
          "minimum": 0,
          "maximum": 100
        }
      },
      "required": ["text_snippet"],
      "additionalProperties": false
    },
    "provenanceArray": {
      "type": "array",
      "description": "Array of provenance objects for multi-source fields (derived/aggregated values)",
      "items": {
        "$ref": "#/$defs/provenance"
      },
      "minItems": 1
    },
    "codeObject": {
      "type": "object",
      "description": "USDM Code object with NCI Thesaurus reference",
      "properties": {
        "code": {
          "type": "string",
          "description": "NCI Thesaurus concept code (e.g., C49686)"
        },
        "decode": {
          "type": "string",
          "description": "Human-readable value"
        },
        "codeSystem": {
          "type": "string",
          "description": "Code system URI or name"
        },
        "codeSystemVersion": {
          "type": "string",
          "description": "Code system version (e.g., 24.03e)"
        },
        "provenance": {
          "$ref": "#/$defs/provenance",
          "description": "Source tracking for this coded value"
        }
      },
      "required": ["code", "decode", "codeSystem", "codeSystemVersion", "provenance"],
      "additionalProperties": false
    },
    "studyPhaseCode": {
      "type": "object",
      "description": "Study phase per CDISC CT (Trial Phase Response codelist) - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C15600" }, "decode": { "const": "Phase 1" } } },
        { "properties": { "code": { "const": "C49686" }, "decode": { "const": "Phase 2A" } } },
        { "properties": { "code": { "const": "C49688" }, "decode": { "const": "Phase 2B" } } },
        { "properties": { "code": { "const": "C15601" }, "decode": { "const": "Phase 2" } } },
        { "properties": { "code": { "const": "C49687" }, "decode": { "const": "Phase 3A" } } },
        { "properties": { "code": { "const": "C49689" }, "decode": { "const": "Phase 3B" } } },
        { "properties": { "code": { "const": "C15602" }, "decode": { "const": "Phase 3" } } },
        { "properties": { "code": { "const": "C15603" }, "decode": { "const": "Phase 4" } } },
        { "properties": { "code": { "const": "C15693" }, "decode": { "const": "Phase 1/Phase 2" } } },
        { "properties": { "code": { "const": "C15694" }, "decode": { "const": "Phase 2/Phase 3" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": {
          "type": "string",
          "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl"
        },
        "codeSystemVersion": {
          "type": "string",
          "minLength": 1,
          "maxLength": 20
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["code", "decode", "codeSystem", "codeSystemVersion", "provenance"],
      "additionalProperties": false
    },
    "studyTypeCode": {
      "type": "object",
      "description": "Study type per CDISC CT (Study Type Response codelist) - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C98388" }, "decode": { "const": "Interventional" } } },
        { "properties": { "code": { "const": "C142615" }, "decode": { "const": "Observational" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": {
          "type": "string",
          "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl"
        },
        "codeSystemVersion": {
          "type": "string",
          "minLength": 1,
          "maxLength": 20
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["code", "decode", "codeSystem", "codeSystemVersion", "provenance"],
      "additionalProperties": false
    },
    "sexCode": {
      "type": "object",
      "description": "Sex per CDISC CT (Sex codelist) - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C20197" }, "decode": { "const": "Male" } } },
        { "properties": { "code": { "const": "C16576" }, "decode": { "const": "Female" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["code", "decode"],
      "additionalProperties": false
    },
    "milestoneDate": {
      "type": ["object", "null"],
      "description": "Milestone date object (can be null if date is not yet known)",
      "properties": {
        "date": {
          "type": ["string", "null"],
          "description": "ISO date format YYYY-MM-DD (can be null if anticipated)",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$"
        },
        "dateType": {
          "type": "string",
          "description": "Whether date is actual or anticipated",
          "enum": ["Actual", "Anticipated"]
        },
        "description": {
          "type": "string",
          "description": "Optional context for the date",
          "maxLength": 200
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "additionalProperties": false
    },
    "textWithProvenance": {
      "type": "object",
      "description": "Text value with integrated provenance - makes value/provenance relationship explicit",
      "properties": {
        "value": {
          "type": "string",
          "description": "The text value"
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["value", "provenance"],
      "additionalProperties": false
    },
    "textArrayWithProvenance": {
      "type": "object",
      "description": "Array of text values with shared provenance - for lists from single source",
      "properties": {
        "values": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1
        },
        "provenance": {
          "$ref": "#/$defs/provenance"
        }
      },
      "required": ["values", "provenance"],
      "additionalProperties": false
    }
  },
  "additionalProperties": false
}
