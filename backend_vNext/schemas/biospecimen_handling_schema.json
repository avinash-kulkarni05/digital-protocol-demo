{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "BiospecimenHandling",
  "description": "USDM 4.0-compliant schema for protocol-agnostic biospecimen handling extraction. Designed for 2-pass extraction with discovery-based specimen identification supporting kit generation, LIMS integration, and logistics coordination.",
  "type": "object",
  "definitions": {
    "provenance": {
      "type": "object",
      "description": "Source location information for audit trail - populated in Pass 2 only",
      "properties": {
        "section_number": {
          "type": ["string", "null"],
          "description": "Section number from document (e.g., '5.3.1', '8.2')",
          "maxLength": 50
        },
        "page_number": {
          "type": ["integer", "null"],
          "description": "PDF page number (1-indexed)"
        },
        "text_snippet": {
          "type": ["string", "null"],
          "description": "Direct quote from source (max 500 chars)",
          "maxLength": 500
        }
      }
    },
    "biomedicalConcept": {
      "type": ["object", "null"],
      "description": "CDISC Biomedical Concept for specimen type standardization",
      "properties": {
        "conceptName": {
          "type": "string",
          "description": "Standardized specimen name",
          "maxLength": 150
        },
        "cdiscCode": {
          "type": "string",
          "description": "NCI EVS code (e.g., C12434 for Whole Blood) or 'CUSTOM' for unmapped",
          "maxLength": 20
        },
        "domain": {
          "type": "string",
          "description": "CDISC domain - BS for Biospecimen, LB for Laboratory",
          "enum": ["BS", "LB", "PC", "PP", "OTHER"],
          "default": "BS"
        },
        "specimen": {
          "type": ["string", "null"],
          "description": "Specimen type (blood, serum, plasma, urine, tissue, etc.)",
          "maxLength": 50
        },
        "method": {
          "type": ["string", "null"],
          "description": "Collection or processing method",
          "maxLength": 100
        },
        "confidence": {
          "type": ["number", "null"],
          "description": "Mapping confidence (1.0 = exact match, 0.5 = custom)",
          "minimum": 0,
          "maximum": 1
        },
        "rationale": {
          "type": ["string", "null"],
          "description": "Brief explanation for code assignment",
          "maxLength": 200
        }
      },
      "required": ["conceptName", "cdiscCode", "domain"]
    },
    "temperature_range": {
      "type": "object",
      "description": "Temperature specification with acceptable range",
      "properties": {
        "nominal": {
          "type": ["number", "null"],
          "description": "Target/nominal temperature in Celsius"
        },
        "min": {
          "type": ["number", "null"],
          "description": "Minimum acceptable temperature in Celsius"
        },
        "max": {
          "type": ["number", "null"],
          "description": "Maximum acceptable temperature in Celsius"
        },
        "description": {
          "type": ["string", "null"],
          "description": "Text description (e.g., 'ambient', 'frozen', '-70°C to -90°C')",
          "maxLength": 100
        }
      }
    },
    "time_window": {
      "type": "object",
      "description": "Time constraint specification",
      "properties": {
        "value": {
          "type": ["number", "null"],
          "description": "Numeric time value"
        },
        "unit": {
          "type": ["string", "null"],
          "description": "Time unit (minutes, hours, days)",
          "maxLength": 100
        },
        "description": {
          "type": ["string", "null"],
          "description": "Full text description if complex",
          "maxLength": 200
        }
      }
    },
    "volume_specification": {
      "type": "object",
      "description": "Volume with units and population-specific variants",
      "properties": {
        "value": {
          "type": ["number", "null"],
          "description": "Volume value"
        },
        "unit": {
          "type": "string",
          "description": "Volume unit (mL, µL, L)",
          "maxLength": 20
        },
        "population": {
          "type": ["string", "null"],
          "description": "Population this volume applies to (adult, pediatric, etc.)",
          "maxLength": 50
        }
      }
    }
  },
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this biospecimen handling resource",
      "maxLength": 50
    },
    "instanceType": {
      "type": "string",
      "const": "BiospecimenHandling",
      "description": "USDM instance type"
    },
    "name": {
      "type": "string",
      "description": "Name of the biospecimen handling resource",
      "maxLength": 200
    },
    "description": {
      "type": ["string", "null"],
      "description": "Brief description of the biospecimen program",
      "maxLength": 500
    },
    "central_laboratory": {
      "type": ["object", "null"],
      "description": "Central/reference laboratory information if specified",
      "properties": {
        "vendor_name": {
          "type": ["string", "null"],
          "description": "Name of central lab vendor",
          "maxLength": 200
        },
        "location": {
          "type": ["string", "null"],
          "description": "Location/address of lab",
          "maxLength": 300
        },
        "accreditations": {
          "type": ["array", "null"],
          "items": {"type": "string", "maxLength": 100},
          "description": "Lab accreditations (CAP, CLIA, ISO 15189, GLP)"
        },
        "contact_info": {
          "type": ["string", "null"],
          "description": "Contact information for specimens",
          "maxLength": 300
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },
    "discovered_specimen_types": {
      "type": "array",
      "description": "Specimen types discovered from protocol - discovery-first, not prescribed",
      "items": {
        "type": "object",
        "properties": {
          "specimen_id": {
            "type": "string",
            "description": "Unique specimen type identifier (e.g., SPEC-001)",
            "maxLength": 50
          },
          "specimen_name": {
            "type": "string",
            "description": "Specimen name as stated in protocol",
            "maxLength": 200
          },
          "specimen_category": {
            "type": ["string", "null"],
            "description": "Category: blood, urine, tissue, csf, saliva, stool, swab, other",
            "maxLength": 50
          },
          "specimen_subtype": {
            "type": ["string", "null"],
            "description": "Subtype: whole_blood, serum, plasma, edta_plasma, citrate_plasma, urine_spot, urine_24h, etc.",
            "maxLength": 100
          },
          "purpose": {
            "type": ["string", "null"],
            "description": "Purpose of collection: pk, pd, biomarker, safety, efficacy, exploratory, genetic",
            "maxLength": 100
          },
          "purpose_description": {
            "type": ["string", "null"],
            "description": "Detailed description of specimen purpose",
            "maxLength": 600
          },
          "biomedicalConcept": {
            "$ref": "#/definitions/biomedicalConcept"
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["specimen_id", "specimen_name"]
      }
    },
    "collection_containers": {
      "type": "array",
      "description": "Collection tubes/containers discovered from protocol",
      "items": {
        "type": "object",
        "properties": {
          "container_id": {
            "type": "string",
            "description": "Unique container identifier (e.g., TUBE-001)",
            "maxLength": 50
          },
          "container_name": {
            "type": "string",
            "description": "Container name/description",
            "maxLength": 200
          },
          "tube_type": {
            "type": ["string", "null"],
            "description": "Tube type if blood collection (SST, EDTA, lithium_heparin, sodium_citrate, etc.)",
            "maxLength": 100
          },
          "tube_color": {
            "type": ["string", "null"],
            "description": "Tube cap color (red, lavender, green, blue, gold, gray, etc.)",
            "maxLength": 50
          },
          "anticoagulant": {
            "type": ["string", "null"],
            "description": "Anticoagulant if applicable",
            "maxLength": 100
          },
          "preservative": {
            "type": ["string", "null"],
            "description": "Preservative if applicable",
            "maxLength": 100
          },
          "volume_capacity": {
            "$ref": "#/definitions/volume_specification"
          },
          "fill_volume": {
            "$ref": "#/definitions/volume_specification"
          },
          "specimen_ref": {
            "type": ["string", "null"],
            "description": "Reference to specimen type ID this container is for",
            "maxLength": 50
          },
          "special_instructions": {
            "type": ["string", "null"],
            "description": "Special handling for this container type",
            "maxLength": 400
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["container_id", "container_name"]
      }
    },
    "collection_schedule": {
      "type": "array",
      "description": "Collection schedule/timepoints discovered from protocol",
      "items": {
        "type": "object",
        "properties": {
          "schedule_id": {
            "type": "string",
            "description": "Unique schedule entry identifier (e.g., COL-001)",
            "maxLength": 50
          },
          "specimen_ref": {
            "type": ["string", "null"],
            "description": "Reference to specimen type ID",
            "maxLength": 50
          },
          "timepoint_name": {
            "type": "string",
            "description": "Name of collection timepoint",
            "maxLength": 200
          },
          "timepoint_type": {
            "type": ["string", "null"],
            "description": "Type: screening, baseline, pre_dose, post_dose, treatment, follow_up, unscheduled, end_of_treatment",
            "maxLength": 50
          },
          "relative_time": {
            "type": ["string", "null"],
            "description": "Timing relative to reference point (e.g., 'Day 1', 'Week 4', '2 hours post-dose')",
            "maxLength": 200
          },
          "collection_window": {
            "$ref": "#/definitions/time_window"
          },
          "number_of_samples": {
            "type": ["integer", "null"],
            "description": "Number of samples to collect at this timepoint"
          },
          "volume_per_sample": {
            "$ref": "#/definitions/volume_specification"
          },
          "fasting_required": {
            "type": ["boolean", "null"],
            "description": "Whether fasting is required"
          },
          "fasting_duration": {
            "type": ["string", "null"],
            "description": "Fasting duration if required (e.g., '8 hours', 'overnight')",
            "maxLength": 100
          },
          "special_conditions": {
            "type": ["string", "null"],
            "description": "Special collection conditions (time of day, patient position, etc.)",
            "maxLength": 400
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["schedule_id", "timepoint_name"]
      }
    },
    "processing_requirements": {
      "type": "array",
      "description": "Processing/handling requirements for specimens",
      "items": {
        "type": "object",
        "properties": {
          "processing_id": {
            "type": "string",
            "description": "Unique processing requirement identifier (e.g., PROC-001)",
            "maxLength": 50
          },
          "specimen_ref": {
            "type": ["string", "null"],
            "description": "Reference to specimen type ID this applies to",
            "maxLength": 50
          },
          "processing_step": {
            "type": "string",
            "description": "Name/description of processing step",
            "maxLength": 200
          },
          "step_order": {
            "type": ["integer", "null"],
            "description": "Order of this step in processing workflow"
          },
          "time_constraint": {
            "$ref": "#/definitions/time_window"
          },
          "time_zero_reference": {
            "type": ["string", "null"],
            "description": "What 'time zero' is measured from (collection, processing_start, centrifugation, etc.)",
            "maxLength": 100
          },
          "temperature_during_processing": {
            "$ref": "#/definitions/temperature_range"
          },
          "centrifuge_speed": {
            "type": ["string", "null"],
            "description": "Centrifuge speed if applicable (e.g., '3000 rpm', '1500 x g')",
            "maxLength": 100
          },
          "centrifuge_time": {
            "type": ["string", "null"],
            "description": "Centrifugation duration",
            "maxLength": 50
          },
          "centrifuge_temperature": {
            "$ref": "#/definitions/temperature_range"
          },
          "aliquot_count": {
            "type": ["integer", "null"],
            "description": "Number of aliquots to create"
          },
          "aliquot_volume": {
            "$ref": "#/definitions/volume_specification"
          },
          "aliquot_container": {
            "type": ["string", "null"],
            "description": "Container type for aliquots (cryovial, microtube, etc.)",
            "maxLength": 100
          },
          "special_instructions": {
            "type": ["string", "null"],
            "description": "Special processing instructions",
            "maxLength": 400
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["processing_id", "processing_step"]
      }
    },
    "storage_requirements": {
      "type": "array",
      "description": "Storage specifications for specimens",
      "items": {
        "type": "object",
        "properties": {
          "storage_id": {
            "type": "string",
            "description": "Unique storage requirement identifier (e.g., STOR-001)",
            "maxLength": 50
          },
          "specimen_ref": {
            "type": ["string", "null"],
            "description": "Reference to specimen type ID",
            "maxLength": 50
          },
          "storage_phase": {
            "type": ["string", "null"],
            "description": "Phase: temporary, short_term, long_term, archive",
            "maxLength": 50
          },
          "temperature_condition": {
            "$ref": "#/definitions/temperature_range"
          },
          "storage_duration": {
            "type": ["string", "null"],
            "description": "Duration of storage at this condition",
            "maxLength": 100
          },
          "equipment_type": {
            "type": ["string", "null"],
            "description": "Equipment type: refrigerator, freezer_minus20, freezer_minus80, ln2_vapor, ln2_liquid",
            "maxLength": 100
          },
          "monitoring_requirements": {
            "type": ["string", "null"],
            "description": "Temperature monitoring requirements",
            "maxLength": 300
          },
          "excursion_limits": {
            "type": ["string", "null"],
            "description": "Acceptable temperature excursions and duration",
            "maxLength": 300
          },
          "backup_requirements": {
            "type": ["string", "null"],
            "description": "Backup storage requirements",
            "maxLength": 300
          },
          "stability_limit": {
            "type": ["string", "null"],
            "description": "Maximum stability at this condition",
            "maxLength": 100
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["storage_id"]
      }
    },
    "shipping_requirements": {
      "type": "array",
      "description": "Shipping/transport specifications",
      "items": {
        "type": "object",
        "properties": {
          "shipping_id": {
            "type": "string",
            "description": "Unique shipping requirement identifier (e.g., SHIP-001)",
            "maxLength": 50
          },
          "specimen_ref": {
            "type": ["string", "null"],
            "description": "Reference to specimen type ID",
            "maxLength": 50
          },
          "origin_description": {
            "type": ["string", "null"],
            "description": "Origin of shipment (e.g., 'investigator sites', 'local lab')",
            "maxLength": 200
          },
          "destination": {
            "type": ["string", "null"],
            "description": "Destination (central lab name/location)",
            "maxLength": 200
          },
          "shipping_frequency": {
            "type": ["string", "null"],
            "description": "How often shipments occur (e.g., 'weekly', 'batch on Day 5')",
            "maxLength": 100
          },
          "temperature_condition": {
            "$ref": "#/definitions/temperature_range"
          },
          "packaging_requirements": {
            "type": ["string", "null"],
            "description": "Packaging specifications",
            "maxLength": 400
          },
          "temperature_monitor": {
            "type": ["string", "null"],
            "description": "Temperature monitor type required",
            "maxLength": 100
          },
          "courier_requirements": {
            "type": ["string", "null"],
            "description": "Courier/carrier requirements",
            "maxLength": 200
          },
          "un_classification": {
            "type": ["string", "null"],
            "description": "UN dangerous goods classification if applicable (UN3373, etc.)",
            "maxLength": 50
          },
          "customs_requirements": {
            "type": ["string", "null"],
            "description": "Import/export documentation requirements",
            "maxLength": 300
          },
          "manifest_requirements": {
            "type": ["string", "null"],
            "description": "Shipping manifest requirements",
            "maxLength": 300
          },
          "contingency_procedures": {
            "type": ["string", "null"],
            "description": "Procedures for delays, excursions, lost shipments",
            "maxLength": 400
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["shipping_id"]
      }
    },
    "kit_specifications": {
      "type": ["object", "null"],
      "description": "Collection kit specifications if defined",
      "properties": {
        "kit_provider": {
          "type": ["string", "null"],
          "description": "Kit provider/vendor name",
          "maxLength": 200
        },
        "kit_components": {
          "type": ["array", "null"],
          "description": "Components included in kit",
          "items": {
            "type": "object",
            "properties": {
              "component_name": {
                "type": "string",
                "description": "Component name",
                "maxLength": 200
              },
              "quantity": {
                "type": ["integer", "null"],
                "description": "Quantity per kit"
              },
              "description": {
                "type": ["string", "null"],
                "description": "Component description",
                "maxLength": 300
              }
            }
          }
        },
        "labeling_requirements": {
          "type": ["string", "null"],
          "description": "Label specifications",
          "maxLength": 400
        },
        "barcode_format": {
          "type": ["string", "null"],
          "description": "Barcode format (Code 128, DataMatrix, QR, etc.)",
          "maxLength": 100
        },
        "label_content": {
          "type": ["string", "null"],
          "description": "Required label content (study, site, subject, visit, specimen, aliquot)",
          "maxLength": 300
        },
        "kit_ordering": {
          "type": ["string", "null"],
          "description": "How/when to order kits",
          "maxLength": 300
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },
    "quality_requirements": {
      "type": ["object", "null"],
      "description": "Quality control requirements",
      "properties": {
        "acceptance_criteria": {
          "type": ["string", "null"],
          "description": "Specimen acceptance criteria",
          "maxLength": 400
        },
        "rejection_criteria": {
          "type": ["string", "null"],
          "description": "Criteria for specimen rejection",
          "maxLength": 400
        },
        "minimum_volume": {
          "$ref": "#/definitions/volume_specification"
        },
        "chain_of_custody": {
          "type": ["string", "null"],
          "description": "Chain of custody requirements",
          "maxLength": 400
        },
        "documentation_requirements": {
          "type": ["string", "null"],
          "description": "Required documentation",
          "maxLength": 400
        },
        "quality_metrics": {
          "type": ["string", "null"],
          "description": "Quality metrics to track",
          "maxLength": 400
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },
    "regulatory_requirements": {
      "type": ["object", "null"],
      "description": "Regulatory and consent requirements",
      "properties": {
        "informed_consent_requirements": {
          "type": ["string", "null"],
          "description": "Specific consent requirements for specimens",
          "maxLength": 400
        },
        "genetic_consent": {
          "type": ["boolean", "null"],
          "description": "Whether separate genetic consent is required"
        },
        "future_use_consent": {
          "type": ["boolean", "null"],
          "description": "Whether consent covers future unspecified use"
        },
        "withdrawal_procedures": {
          "type": ["string", "null"],
          "description": "Procedures for specimen destruction on consent withdrawal",
          "maxLength": 400
        },
        "export_requirements": {
          "type": ["string", "null"],
          "description": "Export permit/MTA requirements",
          "maxLength": 300
        },
        "privacy_requirements": {
          "type": ["string", "null"],
          "description": "De-identification/privacy requirements (GDPR, HIPAA)",
          "maxLength": 300
        },
        "retention_period": {
          "type": ["string", "null"],
          "description": "Required retention period",
          "maxLength": 100
        },
        "destruction_procedures": {
          "type": ["string", "null"],
          "description": "Destruction/disposal procedures",
          "maxLength": 300
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },
    "volume_summary": {
      "type": ["object", "null"],
      "description": "Summary of blood/sample volume burden",
      "properties": {
        "total_blood_volume_per_visit": {
          "type": ["string", "null"],
          "description": "Typical blood volume per visit",
          "maxLength": 100
        },
        "total_blood_volume_per_subject": {
          "type": ["string", "null"],
          "description": "Total blood volume over study duration",
          "maxLength": 100
        },
        "maximum_single_draw": {
          "type": ["string", "null"],
          "description": "Maximum volume from single collection",
          "maxLength": 100
        },
        "pediatric_adjustments": {
          "type": ["string", "null"],
          "description": "Volume adjustments for pediatric subjects if applicable",
          "maxLength": 300
        },
        "volume_limit_compliance": {
          "type": ["string", "null"],
          "description": "Statement of compliance with volume guidelines (WHO/FDA)",
          "maxLength": 300
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },
    "extraction_statistics": {
      "type": "object",
      "description": "Statistics about extracted data",
      "properties": {
        "total_specimen_types_discovered": {
          "type": "integer",
          "description": "Count of distinct specimen types found"
        },
        "total_collection_containers": {
          "type": "integer",
          "description": "Count of container types"
        },
        "total_collection_timepoints": {
          "type": "integer",
          "description": "Count of collection timepoints"
        },
        "total_processing_steps": {
          "type": "integer",
          "description": "Count of processing requirements"
        },
        "total_storage_conditions": {
          "type": "integer",
          "description": "Count of storage specifications"
        },
        "total_shipping_routes": {
          "type": "integer",
          "description": "Count of shipping requirements"
        },
        "has_kit_specifications": {
          "type": "boolean",
          "description": "Whether kit specs were found"
        },
        "has_quality_requirements": {
          "type": "boolean",
          "description": "Whether QC requirements were found"
        },
        "has_regulatory_requirements": {
          "type": "boolean",
          "description": "Whether regulatory requirements were found"
        }
      }
    }
  },
  "required": [
    "id",
    "instanceType",
    "name"
  ],
  "additionalProperties": false
}
