{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://usdm.cdisc.org/v4.0/concomitant_medications_schema.json",
  "title": "USDM 4.0 Concomitant Medications Extraction Schema (Pass 1 - Values Only)",
  "description": "Schema for extracting medication restrictions, drug interactions, and washout requirements. Values only - provenance added in Pass 2.",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this extraction",
      "pattern": "^[A-Za-z0-9_-]+-concomitant-medications$"
    },
    "instanceType": {
      "type": "string",
      "const": "ConcomitantMedicationRestrictions",
      "description": "USDM 4.0 instance type"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for this extraction",
      "maxLength": 150
    },
    "description": {
      "type": "string",
      "description": "Brief description of medication restrictions",
      "maxLength": 500
    },

    "prohibited_medications": {
      "type": "array",
      "description": "Medications completely banned during study",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique identifier (e.g., proh-001, proh-002)"
          },
          "instanceType": {
            "type": "string",
            "const": "ProhibitedMedication"
          },
          "medication_class": {
            "type": "string",
            "description": "Drug class or category name",
            "maxLength": 150
          },
          "specific_drugs": {
            "type": ["array", "null"],
            "description": "Specific drug names if listed (generic names)",
            "items": {"type": "string", "maxLength": 100}
          },
          "prohibition_reason": {
            "$ref": "#/definitions/prohibition_reason_code",
            "description": "Standardized reason for prohibition"
          },
          "prohibition_reason_detail": {
            "type": ["string", "null"],
            "description": "Detailed explanation of prohibition reason",
            "maxLength": 300
          },
          "prohibition_period": {
            "$ref": "#/definitions/prohibition_period_code",
            "description": "When prohibition applies"
          },
          "prohibition_period_detail": {
            "type": ["string", "null"],
            "description": "Specific period details (e.g., '14 days before first dose through 30 days after last dose')",
            "maxLength": 200
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType", "medication_class"]
      }
    },

    "restricted_medications": {
      "type": "array",
      "description": "Medications allowed under specific conditions",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "instanceType": {
            "type": "string",
            "const": "RestrictedMedication"
          },
          "medication_class": {
            "type": "string",
            "description": "Drug class or category",
            "maxLength": 150
          },
          "specific_drugs": {
            "type": ["array", "null"],
            "items": {"type": "string", "maxLength": 100}
          },
          "restriction_type": {
            "$ref": "#/definitions/restriction_type_code",
            "description": "Type of restriction applied"
          },
          "conditions": {
            "type": "object",
            "description": "Conditions for allowed use",
            "properties": {
              "max_dose": {
                "type": ["string", "null"],
                "description": "Maximum allowed dose (e.g., '10mg/day prednisone equivalent')",
                "maxLength": 100
              },
              "max_duration_days": {
                "type": ["integer", "null"],
                "description": "Maximum days of use"
              },
              "approval_required_from": {
                "type": ["string", "null"],
                "enum": ["investigator", "medical_monitor", "sponsor", "not_specified", "investigator_discretion", null],
                "description": "Who must approve use"
              },
              "monitoring_requirements": {
                "type": ["string", "null"],
                "description": "Additional monitoring required",
                "maxLength": 200
              },
              "timing_restriction": {
                "type": ["string", "null"],
                "description": "Timing requirements (e.g., 'not within 4 hours of study drug')",
                "maxLength": 200
              },
              "clinical_scenario": {
                "type": ["string", "null"],
                "description": "When use is permitted",
                "maxLength": 500
              }
            }
          },
          "rationale": {
            "type": ["string", "null"],
            "description": "Reason for restriction",
            "maxLength": 300
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType", "medication_class"]
      }
    },

    "required_medications": {
      "type": "array",
      "description": "Medications that must be administered (premedications, prophylaxis)",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "instanceType": {
            "type": "string",
            "const": "RequiredMedication"
          },
          "medication_name": {
            "type": ["string", "null"],
            "description": "Specific medication name (generic)",
            "maxLength": 150
          },
          "medication_class": {
            "type": "string",
            "description": "Drug class",
            "maxLength": 100
          },
          "requirement_type": {
            "$ref": "#/definitions/requirement_type_code",
            "description": "Type of requirement"
          },
          "dosing": {
            "type": ["object", "null"],
            "properties": {
              "dose": {
                "type": ["string", "null"],
                "description": "Dose specification",
                "maxLength": 100
              },
              "route": {
                "oneOf": [
                  {"$ref": "#/definitions/route_code"},
                  {"type": "null"}
                ],
                "description": "Route of administration"
              },
              "frequency": {
                "type": ["string", "null"],
                "description": "Dosing frequency",
                "maxLength": 150
              }
            }
          },
          "timing": {
            "type": ["object", "null"],
            "properties": {
              "relative_to": {
                "type": ["string", "null"],
                "description": "What timing is relative to",
                "maxLength": 100
              },
              "time_before_minutes": {
                "type": ["integer", "null"],
                "description": "Minutes before reference event"
              },
              "time_after_minutes": {
                "type": ["integer", "null"],
                "description": "Minutes after reference event"
              },
              "timing_description": {
                "type": ["string", "null"],
                "description": "Timing description if not simple minutes",
                "maxLength": 150
              }
            }
          },
          "purpose": {
            "type": "string",
            "description": "Purpose of medication",
            "maxLength": 200
          },
          "alternatives": {
            "type": ["array", "null"],
            "description": "Alternative medications if first-line not available",
            "items": {"type": "string", "maxLength": 200}
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType"]
      }
    },

    "rescue_medications": {
      "type": "array",
      "description": "Allowed rescue/emergency medications",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "instanceType": {
            "type": "string",
            "const": "RescueMedication"
          },
          "medication_name": {
            "type": ["string", "null"],
            "maxLength": 150
          },
          "medication_class": {
            "type": ["string", "null"],
            "maxLength": 100
          },
          "indication": {
            "type": ["string", "null"],
            "description": "When rescue medication is indicated",
            "maxLength": 200
          },
          "dosing_instructions": {
            "type": ["string", "null"],
            "maxLength": 500
          },
          "documentation_required": {
            "type": ["boolean", "null"],
            "description": "Whether use must be documented"
          },
          "impact_on_endpoints": {
            "type": ["string", "null"],
            "description": "How rescue use affects endpoints/analysis",
            "maxLength": 200
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType"]
      }
    },

    "washout_requirements": {
      "type": "array",
      "description": "Washout periods required before study entry",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "instanceType": {
            "type": "string",
            "const": "WashoutRequirement"
          },
          "medication_class": {
            "type": "string",
            "description": "Drug class requiring washout",
            "maxLength": 150
          },
          "specific_drugs": {
            "type": ["array", "null"],
            "items": {"type": "string", "maxLength": 100}
          },
          "washout_duration_days": {
            "type": ["integer", "null"],
            "description": "Washout period in days",
            "minimum": 0
          },
          "washout_duration_half_lives": {
            "type": ["integer", "null"],
            "description": "Washout in half-lives if applicable"
          },
          "washout_description": {
            "type": ["string", "null"],
            "description": "Description if not simple days (e.g., '5 half-lives or 28 days, whichever is longer')",
            "maxLength": 250
          },
          "rationale": {
            "type": ["string", "null"],
            "description": "Reason for washout requirement",
            "maxLength": 300
          },
          "applies_to": {
            "$ref": "#/definitions/washout_applies_to_code",
            "description": "Reference point for washout completion"
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType"]
      }
    },

    "drug_interactions": {
      "type": "array",
      "description": "Drug-drug interactions and CYP450 considerations",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "instanceType": {
            "type": "string",
            "const": "DrugInteraction"
          },
          "interaction_type": {
            "$ref": "#/definitions/interaction_type_code",
            "description": "Type of drug interaction"
          },
          "severity": {
            "$ref": "#/definitions/severity_code",
            "description": "Interaction severity"
          },
          "affected_drugs": {
            "type": ["array", "null"],
            "description": "Specific drugs in this interaction category",
            "items": {"type": "string", "maxLength": 100}
          },
          "clinical_effect": {
            "type": ["string", "null"],
            "description": "Effect on study drug exposure/effect",
            "maxLength": 350
          },
          "management": {
            "$ref": "#/definitions/management_code",
            "description": "How to manage the interaction"
          },
          "management_detail": {
            "type": ["string", "null"],
            "description": "Specific management instructions",
            "maxLength": 400
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType"]
      }
    },

    "allowed_medications": {
      "type": "array",
      "description": "Medications explicitly allowed without restriction",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string"
          },
          "instanceType": {
            "type": "string",
            "const": "AllowedMedication"
          },
          "medication_class": {
            "type": "string",
            "maxLength": 150
          },
          "specific_drugs": {
            "type": ["array", "null"],
            "items": {"type": "string", "maxLength": 100}
          },
          "notes": {
            "type": ["string", "null"],
            "description": "Additional notes about allowed use",
            "maxLength": 350
          },
          "biomedicalConcept": { "$ref": "#/definitions/biomedicalConcept" },
          "provenance": { "$ref": "#/definitions/provenance" }
        },
        "required": ["id", "instanceType"]
      }
    },

    "vaccine_policy": {
      "type": "object",
      "description": "Vaccine restrictions during study",
      "properties": {
        "instanceType": {
          "type": "string",
          "const": "VaccinePolicy"
        },
        "live_vaccines_prohibited": {
          "type": ["boolean", "null"],
          "description": "Whether live vaccines are prohibited"
        },
        "live_vaccine_washout_days": {
          "type": ["integer", "null"],
          "description": "Days before enrollment that live vaccines must be avoided"
        },
        "inactivated_vaccines_allowed": {
          "type": ["boolean", "null"],
          "description": "Whether inactivated vaccines are allowed"
        },
        "covid_vaccine_policy": {
          "type": ["string", "null"],
          "description": "Specific COVID-19 vaccine policy",
          "maxLength": 300
        },
        "specific_restrictions": {
          "type": ["array", "null"],
          "description": "Specific vaccine restrictions",
          "items": {"type": "string", "maxLength": 200}
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      }
    },

    "herbal_supplements_policy": {
      "type": "object",
      "description": "Herbal and dietary supplement restrictions",
      "properties": {
        "instanceType": {
          "type": "string",
          "const": "HerbalSupplementsPolicy"
        },
        "prohibited_supplements": {
          "type": ["array", "null"],
          "description": "Specific prohibited herbal/dietary supplements",
          "items": {"type": "string", "maxLength": 100}
        },
        "rationale": {
          "type": ["string", "null"],
          "description": "Reason for supplement restrictions",
          "maxLength": 300
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      }
    },

    "provenance": { "$ref": "#/definitions/provenance" }
  },

  "required": ["id", "instanceType", "name"],

  "definitions": {
    "provenance": {
      "type": ["object", "null"],
      "description": "Source tracking for extracted data",
      "properties": {
        "section_number": { "type": ["string", "null"], "maxLength": 50 },
        "page_number": { "type": ["integer", "null"] },
        "text_snippet": { "type": ["string", "null"], "maxLength": 500 }
      }
    },
    "biomedicalConcept": {
      "type": ["object", "null"],
      "description": "CDISC Biomedical Concept for regulatory compliance",
      "properties": {
        "conceptName": {
          "type": "string",
          "description": "Standardized drug/medication name",
          "maxLength": 150
        },
        "cdiscCode": {
          "type": "string",
          "description": "NCI EVS code (e.g., C29503 for Warfarin) or 'CUSTOM' for unmapped",
          "maxLength": 20
        },
        "domain": {
          "type": "string",
          "description": "CDISC domain - CM for Concomitant Medications",
          "enum": ["CM", "EX", "DS", "OTHER"],
          "default": "CM"
        },
        "method": {
          "type": ["string", "null"],
          "description": "Administration route (Oral, IV, SC, etc.)",
          "maxLength": 100
        },
        "confidence": {
          "type": ["number", "null"],
          "description": "Mapping confidence (1.0 = exact match, 0.5 = custom)",
          "minimum": 0,
          "maximum": 1
        },
        "rationale": {
          "type": ["string", "null"],
          "description": "Brief explanation for code assignment",
          "maxLength": 200
        }
      },
      "required": ["conceptName", "cdiscCode", "domain"]
    },
    "prohibition_reason_code": {
      "type": "object",
      "description": "Standardized prohibition reason with CDISC terminology",
      "properties": {
        "code": {
          "type": "string",
          "description": "NCI Thesaurus code"
        },
        "decode": {
          "type": "string",
          "enum": ["safety", "efficacy_interference", "drug_interaction", "pk_interaction", "pharmacodynamic", "contraindicated", "study_design"],
          "description": "Prohibition reason"
        },
        "codeSystem": {
          "type": "string",
          "default": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl"
        },
        "codeSystemVersion": {
          "type": "string"
        }
      },
      "required": ["decode"]
    },

    "prohibition_period_code": {
      "type": "object",
      "properties": {
        "code": {"type": "string"},
        "decode": {
          "type": "string",
          "enum": ["screening_only", "treatment_period", "entire_study", "treatment_plus_followup"]
        },
        "codeSystem": {"type": "string"},
        "codeSystemVersion": {"type": "string"}
      },
      "required": ["decode"]
    },

    "restriction_type_code": {
      "type": "object",
      "properties": {
        "code": {"type": "string"},
        "decode": {
          "type": "string",
          "enum": ["dose_limit", "duration_limit", "approval_required", "monitoring_required", "timing_restriction", "conditional_use", "avoid_if_possible", "use_with_caution"]
        },
        "codeSystem": {"type": "string"},
        "codeSystemVersion": {"type": "string"}
      },
      "required": ["decode"]
    },

    "requirement_type_code": {
      "type": "object",
      "properties": {
        "code": {"type": "string"},
        "decode": {
          "type": "string",
          "enum": ["premedication", "prophylaxis", "supportive_care", "rescue", "mandatory_background"]
        },
        "codeSystem": {"type": "string"},
        "codeSystemVersion": {"type": "string"}
      },
      "required": ["decode"]
    },

    "route_code": {
      "type": "object",
      "properties": {
        "code": {"type": ["string", "null"]},
        "decode": {
          "type": "string",
          "enum": ["PO", "IV", "IM", "SC", "topical", "inhaled", "transdermal", "sublingual", "other", "not_specified"]
        },
        "codeSystem": {"type": ["string", "null"]},
        "codeSystemVersion": {"type": ["string", "null"]}
      },
      "required": ["decode"]
    },

    "washout_applies_to_code": {
      "type": "object",
      "properties": {
        "code": {"type": "string"},
        "decode": {
          "type": "string",
          "enum": ["screening", "randomization", "first_dose", "enrollment"]
        },
        "codeSystem": {"type": "string"},
        "codeSystemVersion": {"type": "string"}
      },
      "required": ["decode"]
    },

    "interaction_type_code": {
      "type": "object",
      "properties": {
        "code": {"type": "string"},
        "decode": {
          "type": "string",
          "enum": ["CYP3A4_inhibitor", "CYP3A4_inducer", "CYP2D6_inhibitor", "CYP2D6_inducer", "CYP2C19_inhibitor", "CYP2C19_inducer", "CYP2C9_inhibitor", "CYP2C9_inducer", "CYP1A2_inhibitor", "CYP1A2_inducer", "P_gp_inhibitor", "P_gp_inducer", "BCRP_inhibitor", "OATP_inhibitor", "QT_prolonging", "bleeding_risk", "serotonin_syndrome", "other"]
        },
        "codeSystem": {"type": "string"},
        "codeSystemVersion": {"type": "string"}
      },
      "required": ["decode"]
    },

    "severity_code": {
      "type": "object",
      "properties": {
        "code": {"type": ["string", "null"]},
        "decode": {
          "type": "string",
          "enum": ["strong", "moderate", "weak", "not_specified"]
        },
        "codeSystem": {"type": ["string", "null"]},
        "codeSystemVersion": {"type": ["string", "null"]}
      },
      "required": ["decode"]
    },

    "management_code": {
      "type": "object",
      "properties": {
        "code": {"type": "string"},
        "decode": {
          "type": "string",
          "enum": ["prohibited", "dose_adjustment", "monitoring", "avoid_if_possible", "allowed_with_caution"]
        },
        "codeSystem": {"type": "string"},
        "codeSystemVersion": {"type": "string"}
      },
      "required": ["decode"]
    }
  }
}
