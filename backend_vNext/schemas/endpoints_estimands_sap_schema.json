{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://usdm.cdisc.org/v4.0/endpoints_estimands_sap_schema.json",
  "title": "USDM 4.0 Endpoints, Estimands & SAP Extraction Schema (Combined)",
  "description": "Combined schema for endpoints, estimands (ICH E9 R1), and SAP-specific analyses. Unified efficacy/analysis domain.",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier for this extraction",
      "pattern": "^[A-Za-z0-9_-]+-endpoints-estimands-sap$"
    },
    "instanceType": {
      "type": "string",
      "const": "EndpointsEstimandsSAP",
      "description": "USDM 4.0 instance type"
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for this extraction",
      "maxLength": 200
    },
    "schemaVersion": {
      "type": "string",
      "const": "2.0",
      "description": "Schema version for migration compatibility"
    },
    "documentType": {
      "type": "string",
      "enum": ["protocol", "sap", "both"],
      "description": "Source document type - protocol, SAP, or combined extraction"
    },
    "sourceDocument": {
      "type": "object",
      "description": "Immutable document fingerprint for regulatory traceability",
      "properties": {
        "documentId": { "type": "string" },
        "filename": { "type": "string" },
        "sha256Hash": { "type": "string", "pattern": "^[a-f0-9]{64}$" },
        "byteSize": { "type": "integer", "minimum": 1 },
        "uploadTimestamp": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}" },
        "pageCount": { "type": "integer", "minimum": 1 }
      },
      "required": ["documentId", "filename", "sha256Hash", "uploadTimestamp"]
    },

    "protocol_endpoints": {
      "type": "object",
      "description": "Protocol-level endpoints and estimands (from endpoints_estimands domain)",
      "properties": {
        "objectives": {
          "type": "array",
          "description": "USDM 4.0 Objective resources with level classification",
          "items": { "$ref": "#/definitions/objective" },
          "minItems": 1
        },
        "endpoints": {
          "type": "array",
          "description": "USDM 4.0 Endpoint resources",
          "items": { "$ref": "#/definitions/endpoint" },
          "minItems": 1
        },
        "estimands": {
          "type": "array",
          "description": "USDM 4.0 Estimand resources with ICH E9(R1) compliance",
          "items": { "$ref": "#/definitions/estimand" },
          "minItems": 1
        },
        "analysis_populations": {
          "type": "array",
          "description": "USDM 4.0 AnalysisPopulation resources",
          "items": { "$ref": "#/definitions/analysis_population" },
          "minItems": 1
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      }
    },

    "sap_analyses": {
      "type": "object",
      "description": "SAP-specific analyses (from sap_endpoints_estimands domain)",
      "properties": {
        "sensitivity_analyses": {
          "type": "array",
          "description": "Sensitivity and supplementary analyses per ICH E9(R1)",
          "items": { "$ref": "#/definitions/sensitivity_analysis" }
        },
        "statistical_methods": {
          "type": "array",
          "description": "Statistical analysis methods with model specifications",
          "items": { "$ref": "#/definitions/statistical_method" }
        },
        "subgroup_analyses": {
          "type": "array",
          "description": "Pre-specified subgroup analyses",
          "items": { "$ref": "#/definitions/subgroup_analysis" }
        },
        "multiplicity_adjustment": {
          "type": "object",
          "description": "Multiplicity adjustment strategy",
          "properties": {
            "method": { "type": "string", "maxLength": 100 },
            "description": { "type": "string", "maxLength": 750 },
            "alpha_allocation": { "type": "string", "maxLength": 300 },
            "gatekeeping_strategy": { "type": "string", "maxLength": 300 },
            "provenance": { "$ref": "#/definitions/provenance" }
          }
        },
        "missing_data_handling": {
          "type": "object",
          "description": "Primary missing data handling strategy",
          "properties": {
            "primary_method": { "type": "string", "maxLength": 100 },
            "method_description": { "type": "string", "maxLength": 500 },
            "assumptions": { "type": "array", "items": { "type": "string", "maxLength": 200 } },
            "provenance": { "$ref": "#/definitions/provenance" }
          }
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      }
    },

    "extraction_statistics": {
      "type": "object",
      "properties": {
        "objectives_count": { "type": "integer" },
        "endpoints_count": { "type": "integer" },
        "estimands_count": { "type": "integer" },
        "populations_count": { "type": "integer" },
        "sensitivity_analyses_count": { "type": "integer" },
        "statistical_methods_count": { "type": "integer" },
        "subgroup_analyses_count": { "type": "integer" },
        "has_multiplicity_adjustment": { "type": "boolean" },
        "has_missing_data_strategy": { "type": "boolean" }
      }
    },

    "provenance": { "$ref": "#/definitions/provenance" },

    "_metadata": {
      "type": "object",
      "description": "System metadata added by extraction pipeline (not part of domain schema)",
      "properties": {
        "module_id": { "type": "string" },
        "instance_type": { "type": "string" },
        "pass1_duration_seconds": { "type": "number" },
        "pass2_duration_seconds": { "type": "number" },
        "quality_score": { "type": "object" }
      }
    }
  },

  "required": ["id", "instanceType", "name", "protocol_endpoints"],
  "additionalProperties": false,

  "definitions": {
    "code_object": {
      "type": "object",
      "description": "CDISC controlled terminology code object (generic - use specific definitions when available)",
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "default": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string", "default": "24.03e" }
      },
      "required": ["code", "decode"]
    },
    "objectiveLevelCode": {
      "type": "object",
      "description": "Objective level per CDISC CT - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C85826" }, "decode": { "const": "Primary" } } },
        { "properties": { "code": { "const": "C85827" }, "decode": { "const": "Secondary" } } },
        { "properties": { "code": { "const": "C174265" }, "decode": { "const": "Exploratory" } } },
        { "properties": { "code": { "const": "C49657" }, "decode": { "const": "Safety" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string" }
      },
      "required": ["code", "decode"]
    },
    "endpointLevelCode": {
      "type": "object",
      "description": "Endpoint level per CDISC CT - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C98747" }, "decode": { "const": "Primary" } } },
        { "properties": { "code": { "const": "C98748" }, "decode": { "const": "Secondary" } } },
        { "properties": { "code": { "const": "C174264" }, "decode": { "const": "Exploratory" } } },
        { "properties": { "code": { "const": "C49656" }, "decode": { "const": "Safety" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string" }
      },
      "required": ["code", "decode"]
    },
    "outcomeTypeCode": {
      "type": "object",
      "description": "Outcome type per CDISC CT - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C82583" }, "decode": { "const": "Binary Endpoint" } } },
        { "properties": { "code": { "const": "C25513" }, "decode": { "const": "Continuous Variable" } } },
        { "properties": { "code": { "const": "C25208" }, "decode": { "const": "Time-to-Event Endpoint" } } },
        { "properties": { "code": { "const": "C25463" }, "decode": { "const": "Count Endpoint" } } },
        { "properties": { "code": { "const": "C25284" }, "decode": { "const": "Ordinal Endpoint" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string" }
      },
      "required": ["code", "decode"]
    },
    "populationTypeCode": {
      "type": "object",
      "description": "Population type per CDISC CT - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C71104" }, "decode": { "const": "Intent-to-Treat Population" } } },
        { "properties": { "code": { "const": "C93001" }, "decode": { "const": "Modified Intent-to-Treat Population" } } },
        { "properties": { "code": { "const": "C70927" }, "decode": { "const": "Per-Protocol Population" } } },
        { "properties": { "code": { "const": "C115932" }, "decode": { "const": "Safety Population" } } },
        { "properties": { "code": { "const": "C71105" }, "decode": { "const": "Full Analysis Set" } } },
        { "properties": { "code": { "const": "C71112" }, "decode": { "const": "Pharmacokinetic Population" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string" }
      },
      "required": ["code", "decode"]
    },
    "iceStrategyCode": {
      "type": "object",
      "description": "Intercurrent event strategy per CDISC CT (ICH E9 R1) - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C178899" }, "decode": { "const": "Treatment Policy Strategy" } } },
        { "properties": { "code": { "const": "C178900" }, "decode": { "const": "Composite Strategy" } } },
        { "properties": { "code": { "const": "C178901" }, "decode": { "const": "Hypothetical Strategy" } } },
        { "properties": { "code": { "const": "C178902" }, "decode": { "const": "While on Treatment Strategy" } } },
        { "properties": { "code": { "const": "C178903" }, "decode": { "const": "Principal Stratum Strategy" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string" }
      },
      "required": ["code", "decode"]
    },
    "summaryMeasureCode": {
      "type": "object",
      "description": "Summary measure per CDISC CT - code-decode pairs enforced via oneOf",
      "oneOf": [
        { "properties": { "code": { "const": "C16859" }, "decode": { "const": "Hazard Ratio" } } },
        { "properties": { "code": { "const": "C68680" }, "decode": { "const": "Risk Difference" } } },
        { "properties": { "code": { "const": "C16932" }, "decode": { "const": "Odds Ratio" } } },
        { "properties": { "code": { "const": "C53338" }, "decode": { "const": "Difference in Means of Continuous Variable" } } },
        { "properties": { "code": { "const": "C53279" }, "decode": { "const": "Risk Ratio" } } },
        { "properties": { "code": { "const": "C46110" }, "decode": { "const": "Difference in Medians of Continuous Variable" } } },
        { "properties": { "code": { "const": "C94904" }, "decode": { "const": "Rate Ratio" } } }
      ],
      "properties": {
        "code": { "type": "string" },
        "decode": { "type": "string" },
        "codeSystem": { "type": "string", "const": "http://ncicb.nci.nih.gov/xml/owl/EVS/Thesaurus.owl" },
        "codeSystemVersion": { "type": "string" }
      },
      "required": ["code", "decode"]
    },
    "provenance": {
      "type": "object",
      "description": "Source tracking for extracted data",
      "properties": {
        "section_number": { "type": ["string", "null"], "maxLength": 50 },
        "page_number": { "type": "integer" },
        "text_snippet": { "type": "string", "maxLength": 500 }
      },
      "required": ["page_number", "text_snippet"]
    },
    "objective": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["Objective"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "text": { "type": "string", "minLength": 1, "maxLength": 500 },
        "level": { "$ref": "#/definitions/objectiveLevelCode" },
        "endpoint_ids": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "text", "level", "endpoint_ids", "provenance"]
    },
    "endpoint": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["Endpoint"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "label": { "type": "string", "maxLength": 150 },
        "text": { "type": "string", "minLength": 1, "maxLength": 600 },
        "purpose": { "type": "string", "minLength": 1, "maxLength": 300 },
        "level": { "$ref": "#/definitions/endpointLevelCode" },
        "outcome_type": { "$ref": "#/definitions/outcomeTypeCode" },
        "assessment_method": { "type": ["string", "null"], "maxLength": 200 },
        "assessor": { "type": ["string", "null"], "maxLength": 100 },
        "primary_timepoint_weeks": { "type": ["integer", "null"], "minimum": 0 },
        "assessment_timepoints_weeks": { "type": "array", "items": { "type": "integer" } },
        "analysis_population_id": { "type": "string", "maxLength": 50 },
        "primary_timepoint_text": { "type": "string", "maxLength": 200 },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "text", "purpose", "level", "provenance"]
    },
    "treatment_comparison": {
      "type": "object",
      "properties": {
        "experimental_arm": {
          "type": "object",
          "properties": {
            "arm_type": { "$ref": "#/definitions/code_object" },
            "description": { "type": "string", "maxLength": 300 }
          },
          "required": ["arm_type", "description"]
        },
        "comparator_arm": {
          "type": "object",
          "properties": {
            "arm_type": { "$ref": "#/definitions/code_object" },
            "description": { "type": "string", "maxLength": 300 }
          },
          "required": ["arm_type", "description"]
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["experimental_arm", "comparator_arm", "provenance"]
    },
    "intercurrent_event": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "description": { "type": "string", "maxLength": 300 },
        "strategy": { "$ref": "#/definitions/iceStrategyCode" },
        "strategy_rationale": { "type": "string", "maxLength": 500 },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "name", "strategy"]
    },
    "estimand": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["Estimand"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "text": { "type": "string", "minLength": 1, "maxLength": 500 },
        "endpoint_id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "treatment": { "$ref": "#/definitions/treatment_comparison" },
        "population": {
          "type": "object",
          "properties": {
            "analysis_population_id": { "type": "string" },
            "description": { "type": "string", "maxLength": 300 },
            "provenance": { "$ref": "#/definitions/provenance" }
          },
          "required": ["analysis_population_id", "description"]
        },
        "variable": {
          "type": "object",
          "properties": {
            "endpoint_id": { "type": "string" },
            "description": { "type": "string", "maxLength": 600 },
            "provenance": { "$ref": "#/definitions/provenance" }
          },
          "required": ["endpoint_id", "description"]
        },
        "intercurrent_events": {
          "type": "array",
          "items": { "$ref": "#/definitions/intercurrent_event" },
          "minItems": 1
        },
        "summary_measure": { "$ref": "#/definitions/summaryMeasureCode" },
        "sensitivity_analysis_ids": {
          "type": "array",
          "description": "References to sensitivity analyses for this estimand",
          "items": { "type": "string" }
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "text", "endpoint_id", "treatment", "population", "variable", "intercurrent_events", "summary_measure", "provenance"]
    },
    "analysis_population": {
      "type": "object",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["AnalysisPopulation"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "label": { "type": "string", "maxLength": 50 },
        "text": { "type": "string", "minLength": 1, "maxLength": 500 },
        "population_type": { "$ref": "#/definitions/populationTypeCode" },
        "inclusion_criteria": { "type": "array", "items": { "type": "string" } },
        "exclusion_criteria": { "type": "array", "items": { "type": "string" } },
        "is_primary_for_endpoints": { "type": "array", "items": { "type": "string" } },
        "is_sensitivity_for_endpoints": { "type": "array", "items": { "type": "string" } },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "text", "population_type", "provenance"]
    },
    "sensitivity_analysis": {
      "type": "object",
      "description": "SAP-specific sensitivity/supplementary analysis per ICH E9(R1)",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["SensitivityAnalysis"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "description": { "type": "string", "minLength": 1, "maxLength": 500 },
        "target_estimand_id": {
          "type": ["string", "null"],
          "description": "Reference to the primary estimand this analysis supports (null for standalone analyses)"
        },
        "analysis_type": {
          "$ref": "#/definitions/code_object",
          "description": "Type of analysis (Sensitivity, Supplementary)"
        },
        "purpose": {
          "type": "string",
          "description": "Purpose of this sensitivity analysis",
          "maxLength": 300
        },
        "analysis_population_id": {
          "type": "string",
          "description": "Population used for this analysis"
        },
        "missing_data_handling": {
          "type": "string",
          "description": "Method for handling missing data (LOCF, MMRM, MI, etc.)",
          "maxLength": 100
        },
        "statistical_model": {
          "type": "string",
          "description": "Statistical model specification",
          "maxLength": 300
        },
        "covariates": {
          "type": "array",
          "description": "Covariates included in the analysis",
          "items": { "type": "string" }
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "description", "target_estimand_id", "analysis_type", "purpose", "provenance"]
    },
    "statistical_method": {
      "type": "object",
      "description": "SAP-specific statistical analysis method specification",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["StatisticalMethod"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "description": { "type": "string", "minLength": 1, "maxLength": 500 },
        "for_endpoint_ids": {
          "type": "array",
          "description": "Endpoints this method applies to",
          "items": { "type": "string" }
        },
        "model_type": {
          "type": ["string", "null"],
          "description": "Statistical model type (e.g., CMH, ANCOVA, Cox, MMRM)",
          "maxLength": 150
        },
        "stratification_factors": {
          "type": "array",
          "description": "Stratification factors used in analysis",
          "items": { "type": "string" }
        },
        "covariates": {
          "type": "array",
          "description": "Covariates included in model",
          "items": { "type": "string" }
        },
        "alpha": {
          "type": ["number", "null"],
          "description": "Significance level",
          "minimum": 0,
          "maximum": 1
        },
        "multiplicity": {
          "type": "object",
          "description": "Multiplicity adjustment details",
          "properties": {
            "method": { "type": "string", "maxLength": 100 },
            "description": { "type": "string", "maxLength": 500 }
          }
        },
        "software_package": {
          "type": ["string", "null"],
          "description": "Statistical software used",
          "maxLength": 50
        },
        "procedure": {
          "type": ["string", "null"],
          "description": "Specific procedure used (e.g., PROC MIXED)",
          "maxLength": 100
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "description", "provenance"]
    },
    "subgroup_analysis": {
      "type": "object",
      "description": "SAP-specific pre-specified subgroup analysis",
      "properties": {
        "id": { "type": "string", "minLength": 1, "maxLength": 50 },
        "instanceType": { "type": "string", "enum": ["SubgroupAnalysis"] },
        "name": { "type": "string", "minLength": 1, "maxLength": 100 },
        "description": { "type": "string", "minLength": 1, "maxLength": 500 },
        "for_endpoint_ids": {
          "type": "array",
          "description": "Endpoints this subgroup analysis applies to",
          "items": { "type": "string" }
        },
        "subgroup_variable": {
          "type": "string",
          "description": "Variable used for subgrouping",
          "maxLength": 100
        },
        "categories": {
          "type": "array",
          "description": "Subgroup categories with definitions",
          "items": {
            "type": "object",
            "properties": {
              "name": { "type": "string", "maxLength": 100 },
              "definition": { "type": "string", "maxLength": 200 }
            },
            "required": ["name", "definition"]
          }
        },
        "analysis_method": {
          "type": ["string", "null"],
          "description": "Method for subgroup analysis",
          "maxLength": 300
        },
        "interaction_test": {
          "type": ["boolean", "null"],
          "description": "Whether interaction test will be performed (null if not specified)"
        },
        "forest_plot": {
          "type": ["boolean", "null"],
          "description": "Whether forest plot will be generated (null if not specified)"
        },
        "provenance": { "$ref": "#/definitions/provenance" }
      },
      "required": ["id", "instanceType", "name", "description", "subgroup_variable", "categories", "provenance"]
    }
  }
}
