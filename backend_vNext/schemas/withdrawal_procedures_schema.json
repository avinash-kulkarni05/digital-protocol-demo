{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "WithdrawalProcedures",
  "description": "USDM 4.0-compliant schema for withdrawal and discontinuation procedures. Extracts procedural aspects only - safety thresholds that trigger discontinuation are handled by SafetyParameters module.",
  "type": "object",
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique identifier in format WP-XXX",
      "pattern": "^WP-[A-Z0-9]{3,10}$",
      "minLength": 6,
      "maxLength": 15
    },
    "instanceType": {
      "type": "string",
      "const": "WithdrawalProcedures",
      "description": "USDM 4.0 instance type"
    },
    "name": {
      "type": "string",
      "description": "Name of the withdrawal procedures resource",
      "minLength": 1,
      "maxLength": 150
    },
    "description": {
      "type": "string",
      "description": "Brief description of withdrawal procedures scope",
      "maxLength": 500
    },

    "discontinuation_types": {
      "type": "array",
      "description": "Types of discontinuation defined in protocol",
      "items": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "description": "Unique ID in format DT-XXX",
            "pattern": "^DT-[0-9]{3}$"
          },
          "type_name": {
            "type": "object",
            "description": "CDISC-coded discontinuation type",
            "properties": {
              "code": {
                "type": "string",
                "enum": ["TREATMENT_DISCONTINUATION", "STUDY_WITHDRAWAL", "PARTIAL_WITHDRAWAL", "TEMPORARY_INTERRUPTION"]
              },
              "decode": {
                "type": "string",
                "enum": ["Treatment Discontinuation", "Study Withdrawal", "Partial Withdrawal", "Temporary Interruption"]
              }
            },
            "required": ["code", "decode"]
          },
          "definition": {
            "type": "string",
            "description": "Protocol definition of this discontinuation type",
            "maxLength": 500
          },
          "allows_continued_followup": {
            "type": "boolean",
            "description": "Whether subject can continue follow-up after this discontinuation"
          },
          "provenance": {
            "$ref": "#/definitions/provenance"
          }
        },
        "required": ["id", "type_name", "definition"]
      }
    },

    "consent_withdrawal": {
      "type": "object",
      "description": "Withdrawal of consent procedures and subject rights",
      "properties": {
        "right_to_withdraw": {
          "type": "string",
          "description": "Statement of subject's right to withdraw at any time",
          "maxLength": 300
        },
        "withdrawal_process": {
          "type": "string",
          "description": "How withdrawal is documented and processed",
          "maxLength": 500
        },
        "data_handling_options": {
          "type": "array",
          "description": "Options for handling already-collected data",
          "items": {
            "type": "object",
            "properties": {
              "option": {
                "type": "object",
                "description": "Data handling option code/decode pair",
                "properties": {
                  "code": {
                    "type": "string",
                    "description": "Data handling option code (e.g., RETAIN_ALL, DELETE_ALL)"
                  },
                  "decode": {
                    "type": "string",
                    "description": "Human-readable data handling option"
                  }
                },
                "required": ["code", "decode"]
              },
              "description": {
                "type": "string",
                "maxLength": 200
              }
            }
          }
        },
        "sample_handling": {
          "type": "string",
          "description": "What happens to collected biological samples on withdrawal",
          "maxLength": 500
        },
        "consequences": {
          "type": "string",
          "description": "Consequences of withdrawal (should indicate no penalty)",
          "maxLength": 300
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "discontinuation_visit": {
      "type": "object",
      "description": "Requirements for early termination/discontinuation visit",
      "properties": {
        "timing": {
          "type": "string",
          "description": "When discontinuation visit should occur",
          "maxLength": 300
        },
        "timing_days_from_last_dose": {
          "type": ["integer", "null"],
          "description": "Days from last dose for discontinuation visit",
          "minimum": 0,
          "maximum": 365
        },
        "required_assessments": {
          "type": "array",
          "description": "Assessments required at discontinuation visit",
          "items": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^ASS-[0-9]{3}$"
              },
              "assessment_type": {
                "type": "object",
                "description": "CDISC-coded assessment type",
                "properties": {
                  "code": {
                    "type": "string",
                    "description": "Assessment type code (e.g., PHYSICAL_EXAM, VITAL_SIGNS, LABORATORY)"
                  },
                  "decode": {
                    "type": "string",
                    "description": "Human-readable assessment type"
                  }
                },
                "required": ["code", "decode"]
              },
              "assessment_name": {
                "type": "string",
                "maxLength": 150
              },
              "mandatory": {
                "type": "boolean",
                "description": "Whether assessment is mandatory"
              }
            },
            "required": ["assessment_type", "mandatory"]
          }
        },
        "documentation_requirements": {
          "type": "array",
          "description": "Required documentation at discontinuation",
          "items": {
            "type": "string",
            "maxLength": 300
          }
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "post_discontinuation_followup": {
      "type": "object",
      "description": "Follow-up requirements after discontinuation",
      "properties": {
        "safety_followup": {
          "type": "object",
          "properties": {
            "duration_days": {
              "type": "integer",
              "description": "Days of safety follow-up after last dose",
              "minimum": 0
            },
            "duration_description": {
              "type": "string",
              "maxLength": 300
            },
            "assessments": {
              "type": "array",
              "items": {
                "type": "string",
                "maxLength": 150
              }
            },
            "contact_method": {
              "type": ["object", "null"],
              "properties": {
                "code": {
                  "type": "string",
                  "description": "Contact method code (e.g., IN_PERSON, PHONE, EITHER)"
                },
                "decode": {
                  "type": "string",
                  "description": "Human-readable contact method"
                }
              }
            }
          }
        },
        "survival_followup": {
          "type": "object",
          "description": "Long-term survival follow-up (primarily oncology)",
          "properties": {
            "required": {
              "type": "boolean"
            },
            "frequency": {
              "type": "string",
              "maxLength": 100
            },
            "duration": {
              "type": "string",
              "maxLength": 250
            },
            "information_collected": {
              "type": "array",
              "items": {
                "type": "string",
                "maxLength": 100
              }
            }
          }
        },
        "ae_followup": {
          "type": "object",
          "properties": {
            "ongoing_ae_followup": {
              "type": "boolean",
              "description": "Whether ongoing AEs are followed to resolution"
            },
            "followup_until": {
              "type": "string",
              "description": "When AE follow-up ends",
              "maxLength": 500
            }
          }
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "lost_to_followup": {
      "type": "object",
      "description": "Lost to follow-up definition and procedures",
      "properties": {
        "definition": {
          "type": "string",
          "description": "Protocol definition of lost to follow-up",
          "maxLength": 300
        },
        "missed_visits_threshold": {
          "type": "integer",
          "description": "Number of consecutive missed visits before LTFU",
          "minimum": 1
        },
        "contact_attempts_required": {
          "type": "integer",
          "description": "Number of contact attempts required before declaring LTFU",
          "minimum": 1
        },
        "contact_methods": {
          "type": "array",
          "description": "Methods used to contact subject",
          "items": {
            "type": "object",
            "properties": {
              "code": {
                "type": "string",
                "description": "Contact method code (e.g., PHONE, EMAIL, LETTER)"
              },
              "decode": {
                "type": "string",
                "description": "Human-readable contact method"
              }
            },
            "required": ["code", "decode"]
          }
        },
        "documentation_required": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 400
          }
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "replacement_strategy": {
      "type": "object",
      "description": "Subject replacement strategy",
      "properties": {
        "allows_replacement": {
          "type": "boolean",
          "description": "Whether discontinued subjects can be replaced"
        },
        "replacement_conditions": {
          "type": "array",
          "description": "Conditions under which replacement is allowed",
          "items": {
            "type": "object",
            "properties": {
              "discontinuation_reason": {
                "type": "string",
                "maxLength": 100
              },
              "replacement_allowed": {
                "type": "boolean"
              }
            }
          }
        },
        "timing_cutoff": {
          "type": ["string", "null"],
          "description": "Cutoff for replacement eligibility",
          "maxLength": 200
        },
        "randomization_handling": {
          "type": ["string", "null"],
          "description": "How randomization is handled for replacements",
          "maxLength": 200
        },
        "stratification_maintenance": {
          "type": ["boolean", "null"],
          "description": "Whether stratification is maintained for replacements"
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "administrative_withdrawal": {
      "type": "object",
      "description": "Administrative reasons for withdrawal",
      "properties": {
        "reasons": {
          "type": "array",
          "description": "Administrative withdrawal reasons",
          "items": {
            "type": "object",
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^AWR-[0-9]{3}$"
              },
              "reason_type": {
                "type": "object",
                "properties": {
                  "code": {
                    "type": "string",
                    "enum": ["SITE_CLOSURE", "STUDY_TERMINATION", "SPONSOR_DECISION", "REGULATORY_ACTION", "PROTOCOL_VIOLATION", "INVESTIGATOR_DECISION", "OTHER"]
                  },
                  "decode": {
                    "type": "string",
                    "enum": ["Site Closure", "Study Termination", "Sponsor Decision", "Regulatory Action", "Protocol Violation", "Investigator Decision", "Other"]
                  }
                },
                "required": ["code", "decode"]
              },
              "description": {
                "type": "string",
                "maxLength": 200
              }
            },
            "required": ["reason_type"]
          }
        },
        "notification_requirements": {
          "oneOf": [
            {
              "type": "string",
              "description": "How subjects are notified of administrative withdrawal",
              "maxLength": 500
            },
            {
              "type": "array",
              "description": "List of notification requirements",
              "items": {
                "type": "string",
                "maxLength": 300
              }
            }
          ]
        },
        "irb_notification": {
          "type": "boolean",
          "description": "Whether IRB notification is required"
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "data_retention": {
      "type": "object",
      "description": "Data retention policies for discontinued subjects",
      "properties": {
        "retention_period_years": {
          "type": ["integer", "null"],
          "description": "Years to retain data",
          "minimum": 1
        },
        "retention_policy": {
          "type": "string",
          "description": "Data retention policy description",
          "maxLength": 700
        },
        "analysis_populations": {
          "type": "array",
          "description": "Which analysis populations include discontinued subjects",
          "items": {
            "type": "object",
            "properties": {
              "population": {
                "type": "object",
                "properties": {
                  "code": {
                    "type": "string",
                    "description": "Analysis population code (e.g., ITT, MITT, SAFETY, PP, PK)"
                  },
                  "decode": {
                    "type": "string",
                    "description": "Human-readable population name"
                  }
                },
                "required": ["code", "decode"]
              },
              "inclusion_criteria": {
                "type": "string",
                "maxLength": 500
              }
            }
          }
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "retention_strategies": {
      "type": "object",
      "description": "Strategies to minimize discontinuation and improve retention",
      "properties": {
        "prevention_measures": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 500
          }
        },
        "incentives": {
          "type": "array",
          "items": {
            "type": "string",
            "maxLength": 200
          }
        },
        "re_consent_procedures": {
          "type": "string",
          "maxLength": 1000
        },
        "provenance": {
          "$ref": "#/definitions/provenance"
        }
      }
    },

    "provenance": {
      "$ref": "#/definitions/provenance",
      "description": "Root-level provenance for overall withdrawal procedures"
    },
    "_metadata": {
      "type": "object",
      "description": "Internal metadata from extraction process",
      "additionalProperties": true
    }
  },

  "required": ["id", "instanceType", "name"],
  "additionalProperties": false,

  "definitions": {
    "provenance": {
      "type": "object",
      "description": "Source location in the protocol document",
      "properties": {
        "section_number": {
          "type": "string",
          "description": "Section number from document",
          "maxLength": 20
        },
        "page_number": {
          "type": "integer",
          "description": "Page number in PDF (1-indexed)",
          "minimum": 1
        },
        "text_snippet": {
          "type": "string",
          "description": "Direct quote from source (max 1200 chars)",
          "maxLength": 1200
        },
        "line_start": {
          "type": "integer",
          "description": "Starting line number",
          "minimum": 1
        },
        "line_end": {
          "type": "integer",
          "description": "Ending line number",
          "minimum": 1
        },
        "confidence_score": {
          "type": "number",
          "description": "Confidence score 0-100",
          "minimum": 0,
          "maximum": 100
        },
        "verification_status": {
          "type": "string",
          "enum": ["verified", "verified_adjacent_page", "unverified", "pending"]
        }
      },
      "required": ["section_number", "page_number", "text_snippet"]
    }
  }
}
