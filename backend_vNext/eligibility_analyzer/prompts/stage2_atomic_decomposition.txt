Analyze this eligibility criterion and break it down into atomic, SQL-queryable pieces.

{note_text}

CRITERION:
\"\"\"
{criterion_text}
\"\"\"

Your task:
1. Detect the logic operator: AND or OR

   **OR logic indicators** (patient matches ONE):
   - Explicit "OR" keyword (e.g., "A OR B", "option A or option B")
   - "while on or after" means TWO options: (1) while on treatment, (2) after treatment
   - "either...or" (e.g., "either therapy A or therapy B")
   - "one of the following" (e.g., "must meet ONE of the following criteria")
   - "any of" (e.g., "any of the following conditions")
   - Multiple options listed with "a." "b." preceded by "ONE of" or "OR"

   **AND logic indicators** (patient must have ALL):
   - Explicit "AND" keyword (e.g., "platelet count ≥100,000 AND hemoglobin ≥9.0")
   - Multiple independent requirements with no OR keywords
   - Bullet points or sub-items that ALL must be met

2. **Handle cross-references**:
   - If the criterion references another section (e.g., "as specified in Section 6.5.2"), the referenced content is provided below
   - Use the referenced content to extract specific details (medications, lab values, etc.)
   - Include those specific details in your atomic decomposition (e.g., list specific drug names, not just "prohibited medications")

3. Break into atomic pieces:
   - Each atomic piece should be ONE simple condition that maps to ONE SQL query
   - Normalize the text to be clear and concise
   - Preserve numerical values, units, and timeframes exactly
   - Keep medical terminology but simplify structure
   - **Extract structured quantitative data** (see below for format)

4. For AND logic:
   - Return list of independent atomic criteria
   - Each can be checked separately

5. For OR logic:
   - Return "options" where each option is a set of AND conditions
   - Patient must match ONE complete option

6. **Detect exception clauses (AND NOT logic)**:
   - Look for exceptions that modify an option's logic
   - Common patterns:
     * "EXCEPT if [condition]"
     * "UNLESS [condition]"
     * "unless associated with [condition]"
     * "excluding [condition]"
     * "not including [condition]"
     * "other than [condition]"
     * "with the exception of [condition]"

   - If exception detected:
     * Add "AND_NOT" field to the option with plain English description
     * The option logic becomes: (option conditions are TRUE) AND NOT (exception is TRUE)
     * Keep the exception text clear and concise

   Example: "Deep vein thrombosis within 6 months (EXCEPT if associated with central venous access complication)"
   - Option should have "AND_NOT": "associated with central venous access complication"
   - Evaluation: EXCLUDE patient if (has DVT within 6 months) AND NOT (DVT from central line)

7. **Detect conditional dependencies (IF...THEN relationships)**:
   - Look for conditional logic where one atomic criterion depends on another
   - Common patterns:
     * "IF patient has [condition/biomarker], THEN must have [therapy/procedure]"
     * "appropriate for the patient's [specific characteristic]"
     * "matched to the genomic alteration"
     * "indicated for the subject's [biomarker/condition]"
     * "[therapy] specific to [alteration/subtype]"
     * "for the applicable [alteration/mutation/condition]"
     * Tables mapping biomarkers → specific therapies

   - If conditional dependency detected:
     * Add "dependsOn": "atomicId" field to the dependent criterion (the therapy/procedure that depends on the condition)
     * Add "conditionType": "if_then" to indicate the relationship
     * The "dependsOn" value should reference the atomicId of the prerequisite criterion

   Example: "Subject has EGFR mutation and received EGFR-targeted therapy appropriate for their mutation"
   - ATOMIC_1: "Has EGFR mutation" (independent)
   - ATOMIC_2: "Received EGFR-targeted therapy" (depends on ATOMIC_1)
     → ATOMIC_2 should have: "dependsOn": "1", "conditionType": "if_then"

Return JSON:
{{
  "logicOperator": "AND" or "OR",
  "decompositionStrategy": "1-2 sentences in clinical language explaining your decomposition approach and rationale. Describe what logic pattern you identified, why you broke it down this way, and any clinical reasoning applied.",
  "atomicCriteria": [
    {{
      "atomicId": "1",
      "atomicText": "Simple normalized statement",
      "omopTable": "condition_occurrence" or "measurement" or "drug_exposure" or "procedure_occurrence" or "observation",
      "valueConstraint": "≥100,000/mm³" (if applicable),
      "timeConstraint": "within 7 days before randomization" (if applicable),
      "timeFrameStructured": {{  // NEW: Structured time extraction
        "value": 7,
        "unit": "days",
        "operator": "within",
        "relativeEvent": "randomization"
      }} (if time constraint exists, otherwise null),
      "numericConstraintStructured": {{  // NEW: Structured numeric extraction
        "value": 100000,
        "operator": "≥",
        "unit": "cells/mm³",
        "parameter": "platelet count"
      }} (if single value with operator, otherwise use min/max format below),
      "numericRangeStructured": {{  // NEW: For ranges like "9-13%"
        "min": 9,
        "max": 13,
        "unit": "%",
        "parameter": "HbA1c"
      }} (if range exists, otherwise null),
      "AND_NOT": "plain English exception description" (ONLY if exception exists in AND-logic criterion, otherwise omit this field),
      "dependsOn": "atomicId of prerequisite criterion" (ONLY if conditional dependency exists, otherwise omit this field),
      "conditionType": "if_then" (ONLY if conditional dependency exists, otherwise omit this field),
      "strategy": "Brief clinical explanation (1 sentence) of how this atomic piece was identified and why it's important for patient screening."
    }},
    ...
  ],
  "options": [  // Only if OR logic
    {{
      "optionId": "A",
      "excludePatientIf": "Brief description" (use "excludePatientIf" for Exclusion criteria),
      "includePatientIf": "Brief description" (use "includePatientIf" for Inclusion criteria),
      "AND_NOT": "plain English exception description" (ONLY if exception exists, otherwise omit this field),
      "strategy": "Brief clinical explanation (1 sentence) of why this option represents a distinct patient pathway.",
      "conditions": [
        {{
          "atomicId": "A1",
          "atomicText": "...",
          "omopTable": "...",
          "valueConstraint": "...",
          "timeConstraint": "...",
          "strategy": "Brief clinical explanation (1 sentence) of how this condition contributes to the option logic."
        }},
        ...
      ]
    }},
    ...
  ]
}}

Examples:

Example 1 (AND logic with structured quantitative data):
Input: "Within 7 days before randomization, has adequate bone marrow function defined as: Platelet count ≥100,000/mm³ AND Hemoglobin ≥9.0 g/dL AND Absolute neutrophil count ≥1500/mm³"

Output:
{{
  "logicOperator": "AND",
  "decompositionStrategy": "This criterion was identified as compound AND-logic requiring multiple independent laboratory measurements. It was decomposed into 3 separate atomic pieces to enable independent SQL querying of each hematologic parameter with its specific threshold.",
  "atomicCriteria": [
    {{
      "atomicId": "1",
      "atomicText": "Platelet count measurement",
      "omopTable": "measurement",
      "valueConstraint": "≥100,000/mm³",
      "timeConstraint": "within 7 days before randomization",
      "timeFrameStructured": {{
        "value": 7,
        "unit": "days",
        "operator": "within",
        "relativeEvent": "randomization"
      }},
      "numericConstraintStructured": {{
        "value": 100000,
        "operator": "≥",
        "unit": "cells/mm³",
        "parameter": "platelet count"
      }},
      "numericRangeStructured": null
    }},
    {{
      "atomicId": "2",
      "atomicText": "Hemoglobin measurement",
      "omopTable": "measurement",
      "valueConstraint": "≥9.0 g/dL",
      "timeConstraint": "within 7 days before randomization",
      "timeFrameStructured": {{
        "value": 7,
        "unit": "days",
        "operator": "within",
        "relativeEvent": "randomization"
      }},
      "numericConstraintStructured": {{
        "value": 9.0,
        "operator": "≥",
        "unit": "g/dL",
        "parameter": "hemoglobin"
      }},
      "numericRangeStructured": null
    }},
    {{
      "atomicId": "3",
      "atomicText": "Absolute neutrophil count measurement",
      "omopTable": "measurement",
      "valueConstraint": "≥1500/mm³",
      "timeConstraint": "within 7 days before randomization",
      "timeFrameStructured": {{
        "value": 7,
        "unit": "days",
        "operator": "within",
        "relativeEvent": "randomization"
      }},
      "numericConstraintStructured": {{
        "value": 1500,
        "operator": "≥",
        "unit": "cells/mm³",
        "parameter": "absolute neutrophil count"
      }},
      "numericRangeStructured": null
    }}
  ]
}}

Example 2 (OR logic - explicit OR - Inclusion criterion):
Input: "Received platinum-based chemotherapy in combination with PD-1 inhibitor as only prior line OR received platinum-based chemotherapy and PD-1 inhibitor sequentially as only 2 prior lines"

Output:
{{
  "logicOperator": "OR",
  "decompositionStrategy": "This criterion was recognized as explicit OR-logic with two distinct treatment pathways: concurrent combination therapy vs sequential therapy. Separate options were created to enable patients qualifying through either pathway to be identified via distinct SQL queries.",
  "options": [
    {{
      "optionId": "A",
      "includePatientIf": "Combination therapy (1 line)",
      "conditions": [
        {{
          "atomicId": "A1",
          "atomicText": "Received platinum-based chemotherapy",
          "omopTable": "drug_exposure",
          "valueConstraint": null,
          "timeConstraint": "as prior therapy"
        }},
        {{
          "atomicId": "A2",
          "atomicText": "Received PD-1 or PD-L1 inhibitor",
          "omopTable": "drug_exposure",
          "valueConstraint": null,
          "timeConstraint": "in combination with platinum therapy"
        }},
        {{
          "atomicId": "A3",
          "atomicText": "Only 1 prior line of therapy",
          "omopTable": "observation",
          "valueConstraint": "count = 1",
          "timeConstraint": null
        }}
      ]
    }},
    {{
      "optionId": "B",
      "includePatientIf": "Sequential therapy (2 lines)",
      "conditions": [
        {{
          "atomicId": "B1",
          "atomicText": "Received platinum-based chemotherapy",
          "omopTable": "drug_exposure",
          "valueConstraint": null,
          "timeConstraint": "as prior therapy"
        }},
        {{
          "atomicId": "B2",
          "atomicText": "Received PD-1 or PD-L1 inhibitor",
          "omopTable": "drug_exposure",
          "valueConstraint": null,
          "timeConstraint": "sequential to platinum therapy"
        }},
        {{
          "atomicId": "B3",
          "atomicText": "Only 2 prior lines of therapy",
          "omopTable": "observation",
          "valueConstraint": "count = 2",
          "timeConstraint": null
        }}
      ]
    }}
  ]
}}

Example 3 (OR logic - "while on or after" - Inclusion criterion):
Input: "Subjects must have documentation of radiographic disease progression while on or after receiving the most recent treatment regimen"

Output:
{{
  "logicOperator": "OR",
  "decompositionStrategy": "Implicit OR-logic was detected from 'while on or after' phrasing, indicating two distinct timing scenarios for disease progression. The criterion was split into separate options to capture patients who progressed during treatment vs after treatment completion.",
  "options": [
    {{
      "optionId": "A",
      "includePatientIf": "Progression while on treatment",
      "conditions": [
        {{
          "atomicId": "A1",
          "atomicText": "Radiographic disease progression documented",
          "omopTable": "observation",
          "valueConstraint": "progression event recorded",
          "timeConstraint": "during the most recent treatment regimen"
        }}
      ]
    }},
    {{
      "optionId": "B",
      "includePatientIf": "Progression after treatment",
      "conditions": [
        {{
          "atomicId": "B1",
          "atomicText": "Radiographic disease progression documented",
          "omopTable": "observation",
          "valueConstraint": "progression event recorded",
          "timeConstraint": "after completion of the most recent treatment regimen"
        }}
      ]
    }}
  ]
}}

Example 4 (Range values with structured extraction):
Input: "HbA1c between 9% and 13% AND received thoracic radiation therapy > 30 Gy within 6 months"

Output:
{{
  "logicOperator": "AND",
  "decompositionStrategy": "AND-logic was identified linking two independent clinical requirements: a specific glycemic control range and recent high-dose thoracic radiation. The criterion was separated into atomic pieces to enable independent querying of lab values and procedure history with structured numeric constraints.",
  "atomicCriteria": [
    {{
      "atomicId": "1",
      "atomicText": "HbA1c measurement",
      "omopTable": "measurement",
      "valueConstraint": "9-13%",
      "timeConstraint": null,
      "timeFrameStructured": null,
      "numericConstraintStructured": null,
      "numericRangeStructured": {{
        "min": 9,
        "max": 13,
        "unit": "%",
        "parameter": "HbA1c"
      }}
    }},
    {{
      "atomicId": "2",
      "atomicText": "Received thoracic radiation therapy",
      "omopTable": "procedure_occurrence",
      "valueConstraint": "> 30 Gy",
      "timeConstraint": "within 6 months",
      "timeFrameStructured": {{
        "value": 6,
        "unit": "months",
        "operator": "within",
        "relativeEvent": "trial start"
      }},
      "numericConstraintStructured": {{
        "value": 30,
        "operator": ">",
        "unit": "Gy",
        "parameter": "radiation dose"
      }},
      "numericRangeStructured": null
    }}
  ]
}}

Example 5 (OR logic with exception clause - AND NOT - Exclusion criterion):
Input: "History of any of the following cardiovascular events within 6 months: a) Myocardial infarction b) Unstable angina c) Deep vein thrombosis (EXCEPT if associated with central venous access complication)"

Output:
{{
  "logicOperator": "OR",
  "decompositionStrategy": "OR-logic exclusion criterion was recognized listing multiple cardiovascular events where any single event disqualifies the patient. Separate options were created for each condition, with option C incorporating an exception clause (AND NOT) to allow DVT if it was catheter-related.",
  "options": [
    {{
      "optionId": "A",
      "excludePatientIf": "Myocardial infarction within 6 months",
      "conditions": [
        {{
          "atomicId": "A1",
          "atomicText": "Myocardial infarction documented",
          "omopTable": "condition_occurrence",
          "valueConstraint": null,
          "timeConstraint": "within 6 months",
          "timeFrameStructured": {{
            "value": 6,
            "unit": "months",
            "operator": "within",
            "relativeEvent": "trial start"
          }}
        }}
      ]
    }},
    {{
      "optionId": "B",
      "excludePatientIf": "Unstable angina within 6 months",
      "conditions": [
        {{
          "atomicId": "B1",
          "atomicText": "Unstable angina documented",
          "omopTable": "condition_occurrence",
          "valueConstraint": null,
          "timeConstraint": "within 6 months",
          "timeFrameStructured": {{
            "value": 6,
            "unit": "months",
            "operator": "within",
            "relativeEvent": "trial start"
          }}
        }}
      ]
    }},
    {{
      "optionId": "C",
      "excludePatientIf": "Deep vein thrombosis within 6 months (with exception)",
      "AND_NOT": "associated with central venous access complication",
      "conditions": [
        {{
          "atomicId": "C1",
          "atomicText": "Deep vein thrombosis documented",
          "omopTable": "condition_occurrence",
          "valueConstraint": null,
          "timeConstraint": "within 6 months",
          "timeFrameStructured": {{
            "value": 6,
            "unit": "months",
            "operator": "within",
            "relativeEvent": "trial start"
          }}
        }}
      ]
    }}
  ]
}}

Example 6 (OR within AND logic - Sub-options array - Inclusion criterion):
Input: "Age ≥18 years AND (ECOG performance status 0 OR 1) AND measurable disease per RECIST v1.1"

Output:
{{
  "logicOperator": "AND",
  "hasNestedLogic": true,
  "decompositionStrategy": "Top-level AND logic with 3 independent requirements. Atomic criterion #2 has internal OR choice between two ECOG values. Patient must satisfy: age requirement AND (one of the ECOG values) AND measurable disease. Sub-options array used to preserve OR within AND structure without Cartesian product flattening.",
  "atomicCriteria": [
    {{
      "atomicId": "1",
      "atomicText": "Age ≥18 years",
      "omopTable": "observation",
      "valueConstraint": "≥18 years",
      "timeConstraint": null,
      "timeFrameStructured": null,
      "numericConstraintStructured": {{
        "value": 18,
        "operator": "≥",
        "unit": "years",
        "parameter": "age"
      }},
      "numericRangeStructured": null,
      "hasSubOptions": false,
      "strategy": "Age cutoff ensures adult population capable of informed consent and protocol compliance."
    }},
    {{
      "atomicId": "2",
      "atomicText": "ECOG performance status",
      "omopTable": "observation",
      "valueConstraint": null,
      "hasSubOptions": true,
      "evaluationRule": "Patient must have ONE of the following ECOG values",
      "subOptions": [
        {{
          "subOptionId": "2a",
          "atomicText": "ECOG performance status 0",
          "omopTable": "observation",
          "valueConstraint": "ECOG = 0",
          "timeFrameStructured": null,
          "numericConstraintStructured": {{
            "value": 0,
            "operator": "=",
            "parameter": "ECOG performance status"
          }},
          "numericRangeStructured": null,
          "strategy": "Fully active patients with no restrictions on normal activities."
        }},
        {{
          "subOptionId": "2b",
          "atomicText": "ECOG performance status 1",
          "omopTable": "observation",
          "valueConstraint": "ECOG = 1",
          "timeFrameStructured": null,
          "numericConstraintStructured": {{
            "value": 1,
            "operator": "=",
            "parameter": "ECOG performance status"
          }},
          "numericRangeStructured": null,
          "strategy": "Ambulatory patients with mild symptoms, restricted only in strenuous physical activity."
        }}
      ],
      "strategy": "ECOG 0-1 ensures patients are well enough to tolerate protocol procedures and treatment toxicities. Multiple acceptable ECOG values provide appropriate patient population while maintaining safety margin."
    }},
    {{
      "atomicId": "3",
      "atomicText": "Measurable disease per RECIST v1.1",
      "omopTable": "observation",
      "valueConstraint": "measurable disease present",
      "timeConstraint": null,
      "hasSubOptions": false,
      "strategy": "Measurable disease required for objective tumor response assessment via imaging studies."
    }}
  ]
}}

**Key Pattern Recognition for OR within AND**:
- Input pattern: "A AND (B OR C) AND D"
- Atomic criterion with internal OR choices → use `hasSubOptions: true` + `subOptions` array
- Do NOT flatten to separate options (would duplicate atomic criteria A and D)
- Do NOT merge into single text "B or C" (loses granularity, not SQL-queryable)
- Each sub-option gets its own OMOP concepts in Stage 6

**When to use subOptions within AND-logic atomicCriteria**:
1. Top-level logic is AND
2. One atomic component has internal OR choices (e.g., "ECOG 0 OR 1", "ALT >3× OR AST >3×")
3. The OR choices are semantically related (same parameter with different values/thresholds)
4. Preserves semantic grouping and avoids exponential option explosion

**Examples requiring subOptions**:
- "Age ≥18 AND (ECOG 0 OR 1) AND measurable disease"
- "Bilirubin ≤1.5× ULN AND (ALT ≤3× OR AST ≤3×) AND no cirrhosis"
- "(Male OR post-menopausal female) AND adequate contraception"
- "Stage III disease AND (ECOG 0 OR 1 OR 2) AND prior therapy"

**When NOT to use subOptions**:
- Input is standalone "ECOG 0 or 1" (no other AND components) → Use regular OR-logic options
- Input is "(A AND B) OR (C AND D)" → Use regular OR-logic with conditions per option
- Sub-options would have >5 items (consider regular options for clarity)

**IMPORTANT EXTRACTION RULES**:
1. **timeFrameStructured**: Extract whenever you see time periods like "within X days/weeks/months", "before", "after", "during"
2. **numericConstraintStructured**: Use for single values with operators (>, <, ≥, ≤, =). Extract the numeric value, operator, unit, and parameter name
3. **numericRangeStructured**: Use for ranges like "between X and Y", "X-Y", "from X to Y". Extract min, max, unit, and parameter name
4. **If both time and numeric constraints exist, extract both**
5. **excludePatientIf / includePatientIf**: Use the correct field based on criterion type:
   - For Exclusion criteria: Use "excludePatientIf"
   - For Inclusion criteria: Use "includePatientIf"
   - NEVER include both fields in the same option
6. **AND_NOT**: Add to options when you see exception keywords (EXCEPT, UNLESS, excluding, other than, not including). Extract the plain English exception condition only - do not include the main condition text
7. **Always set null for fields that don't apply to that specific criterion**